var CONFIG={api_url:"",tariff:"Tri-Horario-Semanal",year:"2023",curva_perfil_c:"True",supplier:"coopernico-base",chart_update_interval:15,chart_update_period:12,chart_update_period_net:12,EoTKey:"XXXXXXXXXX",cycle_day:8,profile:"BTN-C",divisor:0,allowDebug:!1};
class ApiService{constructor(a){this.baseUrl=a}async getCurrentPrice(){try{const a=await fetch(`${this.baseUrl}/getCurrentPrice?tariff=${CONFIG.tariff}&year=${CONFIG.year}&supplier=${CONFIG.supplier}&cycle_day=${CONFIG.cycle_day}&profile=${CONFIG.profile}`);if(!a.ok)throw Error(`HTTP error: ${a.status}`);return await a.json()}catch(a){throw console.error(`Error fetching current price: ${a}`),a;}}async getOMIEPricesForPeriod(a,b){try{const d=await fetch(`${this.baseUrl}/getOMIEPricesForPeriod?tariff=${CONFIG.tariff}&supplier=${CONFIG.supplier}&year=${CONFIG.year}&cycle_day=${CONFIG.cycle_day}&profile=${CONFIG.profile}&start_date=${a}&end_date=${b}`);
if(!d.ok)throw Error(`HTTP error: ${d.status}`);return await d.json()}catch(d){throw console.error(`Error fetching OMIE prices for period: ${d}`),d;}}async uploadEnergyFile(a,b,d,c){a=`${this.baseUrl}/uploadEnergyFile?supplier=${CONFIG.supplier}&tariff=${CONFIG.tariff}&year=${CONFIG.year}&cycle_day=${CONFIG.cycle_day}&profile=${CONFIG.profile}&format=${a}&provider=${b}&resampling=${sample}&divisor=${0!=CONFIG.divisor?CONFIG.divisor:""}&lagHour=${0}&datatype=${c}`;b=new FormData;b.append("file",d);
d={method:"POST",body:b};try{const e=await fetch(a,d);if(!e.ok)throw Error(`HTTP error! status: ${e.status}`);return await e.json()}catch(e){throw console.error("Error uploading file:",e),e;}}async getEstimationProfile(a,b,d,c="none"){try{const e=await fetch(`${this.baseUrl}/getEstimationProfile?supplier=${CONFIG.supplier}&tariff=${CONFIG.tariff}&year=${CONFIG.year}&cycle_day=${CONFIG.cycle_day}&profile=${CONFIG.profile}&start_date=${a}&end_date=${b}&total_energy=${d}&records=${c}`);if(!e.ok)throw Error(`HTTP error: ${e.status}`);
return await e.json()}catch(e){throw console.error(`Error fetching estimation profile: ${e}`),e;}}async getEstimationProfileManual(a,b,d,c,e,g=0,k="none"){try{const h=await fetch(`${this.baseUrl}/getEstimationProfileManual?supplier=${CONFIG.supplier}&tariff=${CONFIG.tariff}&year=${CONFIG.year}&cycle_day=${CONFIG.cycle_day}&profile=${CONFIG.profile}&start_date=${a}&end_date=${b}&total_vazio=${d}&total_cheio=${c}&total_ponta=${e}&lagHour=${g}&records=${k}`);if(!h.ok)throw Error(`HTTP error: ${h.status}`);
return await h.json()}catch(h){throw console.error(`Error fetching estimation profile: ${h}`),h;}}async getEOTData(){try{const a=await fetch(`${this.baseUrl}/getEOTData?supplier=${CONFIG.supplier}&tariff=${CONFIG.tariff}&year=${CONFIG.year}&cycle_day=${CONFIG.cycle_day}&profile=${CONFIG.profile}&key=${CONFIG.EoTKey}`);if(!a.ok)throw Error(`HTTP error: ${a.status}`);return await a.json()}catch(a){throw console.error(`Error fetching EOT data: ${a}`),a;}}}
class PriceTracker{constructor(a,b){this.apiService=a;this.chartUpdatePeriod=b;this.lastUpdateChart=new Date;this.analysisChart=this.lastEstimateDataDisplay=this.lastRealDataDisplay=this.lastEstimateDataFetch=this.lastRealDataFetch=null;this.isRealConsumption=!0;this.zoomOptions={pan:{enabled:!0,mode:"x"},zoom:{wheel:{enabled:!0},pinch:{enabled:!0},drag:{enabled:!1},mode:"x"}};this.chartConfig={type:"bar",data:{labels:[],datasets:[{label:"Energia",data:[],borderColor:"rgba(75, 192, 192, 1)",backgroundColor:"rgba(75, 192, 192, 0.2)",
borderWidth:1,tension:.1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{title:{display:!0,text:"Hora"}},y:{title:{display:!0,text:"Pre\u00e7o"}}},plugins:{tooltip:{callbacks:{title:function(d){return"Hora: "+d[0].label+":00"},label:function(d){let c=d.dataset.label||"";c&&="Pre\u00e7o: ";return c+=Number(d.parsed.y).toFixed(2)+" \u20ac/MWh"}}}}}};this.chartConfigNet={type:"bar",data:{labels:[],datasets:[{label:"Energia",data:[],borderColor:"rgba(75, 192, 192, 1)",backgroundColor:"rgba(75, 192, 192, 0.2)",
borderWidth:1,tension:.1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{title:{display:!0,text:"Hora"}},y:{title:{display:!0,text:"Pre\u00e7o"}}},plugins:{tooltip:{callbacks:{title:function(d){return"Hora: "+d[0].label+":00"},label:function(d){let c=d.dataset.label||"";c&&="Pre\u00e7o: ";return c+=Number(d.parsed.y).toFixed(4)+" \u20ac/kWh"}}}}}}}initCharts(){var a=document.getElementById("price-chart");a=new Chart(a,this.chartConfig);var b=document.getElementById("price-chart-net");
b=new Chart(b,this.chartConfigNet);var d=document.getElementById("price-chart-analysis");d=new Chart(d,{type:"line"});return[a,b,d]}formatTitleCase(a){return a.toLowerCase().split("-").map(b=>b.charAt(0).toUpperCase()+b.slice(1)).join("-")}setAnalysisPageforSupplier(a,b){var d=new Date,c=new Date(d.getFullYear(),d.getMonth(),d.getDate()-2,0,0);d=new Date(d.getFullYear(),d.getMonth(),d.getDate()-1,23,59);document.getElementById("analysis-comercializador").textContent=this.formatTitleCase(a);document.getElementById("analysis-opcao-horaria").textContent=
this.formatTitleCase(b);(a="luzboa-spot"===a?!0:!1)?(document.getElementById("title_profile").textContent="C\u00e1lculo do Consumo (Per\u00edodo) :",document.getElementById("analysis-periodo-start").value=this.formatDate(c,!0),document.getElementById("analysis-periodo-end").value=this.formatDate(d,!0)):document.getElementById("title_profile").textContent="Curva Perfil "+CONFIG.profile;document.getElementById("blockFileProvider").style.display="";document.getElementById("blockConsumoEstimado").style.display=
"";document.getElementById("blockChart").style.display="";document.getElementById("analysis-periodo-start").disabled=a?!1:!0;document.getElementById("analysis-periodo-end").disabled=a?!1:!0;c=document.getElementById("blockSwitchChart");a?(c.classList.remove("d-flex"),c.style.display="none"):(c.classList.add("d-flex"),c.style.display="flex");document.getElementById("analysis-energia-profile-vazio-total").textContent="0.00 kWh (0.00 \u20ac)";document.getElementById("analysis-energia-profile-cheio-total").textContent=
"0.00 kWh (0.00 \u20ac)";document.getElementById("analysis-energia-profile-ponta-total").textContent="0.00 kWh (0.00 \u20ac)";document.getElementById("analysis-energia-profile-total").textContent="0.00 kWh";document.getElementById("analysis-custo-profile-total").textContent="0.00 \u20ac";document.getElementById("analysis-custo-profile-preco-medio").textContent="0.000000 \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-vazio").textContent="0.000000 \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-cheio").textContent=
"0.000000 \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-ponta").textContent="0.000000 \u20ac/kWh"}fetchServerData(a,b,d=!1){logger("Fetching Price..."+this.lastUpdateChart);this.apiService.getCurrentPrice().then(c=>{logger("Current Price:",c);const e=new Date;var g=0===c["TAR Period"].dst?" / Inverno":" / Ver\u00e3o";g=0===c["TAR Period"].dias?"Dia de Semana"+g:1===c["TAR Period"].dias?"S\u00e1bado"+g:"Domingo"+g;const k=c["TAR Period"].periodo+": "+c["TAR Period"].start+
" - "+c["TAR Period"].end,h=c["Cycle Period"].start.substring(0,10),f=CONFIG.profile;document.getElementById("current-price-omie").textContent=`${c["OMIE price"].toFixed(2)} \u20ac/MWh`;document.getElementById("current-price-net").textContent=`${c["net price"].toFixed(4)} \u20ac/kWh`;document.getElementById("current-profile").textContent=f;document.getElementById("current-cycle_period").textContent=`${h}`;document.getElementById("current-tarifario").textContent=`${c.Tariff} `;document.getElementById("current-supplier").textContent=
`${this.formatTitleCase(c.Supplier)} `;document.getElementById("current-dia").textContent=`${g} `;document.getElementById("current-periodo").textContent=`${k} `;document.getElementById("current-time").textContent=e.toLocaleTimeString("en-US",{hour12:!1})}).catch(c=>{console.error("Error:",c)});""===CONFIG.EoTKey||/^X*$/.test(CONFIG.EoTKey)?(document.getElementById("current-power").textContent="N/A",document.getElementById("current-consumo-hora").textContent="N/A"):this.apiService.getEOTData().then(c=>
{logger("EoT Data:",c);const e=c.power,g=c.energy_total;c=c.total_cost;document.getElementById("current-power").textContent=`${e} Watts `;document.getElementById("current-consumo-hora").textContent=`${g.toFixed(2)} kWh (${c.toFixed(4)} \u20ac)`}).catch(c=>{console.error("Error:",c)});if((new Date).getHours()!==this.lastUpdateChart.getHours()||1==d)this.lastUpdateChart=this.updateChartPeriod(a,b)}formatDate(a,b=!1){const d=a.getFullYear(),c=String(a.getMonth()+1).padStart(2,"0"),e=String(a.getDate()).padStart(2,
"0"),g=String(a.getHours()).padStart(2,"0");a=String(a.getMinutes()).padStart(2,"0");return b?`${d}-${c}-${e} ${g}:${a}`:`${d}-${c}-${e}-${g}:${a}`}getColor(a,b,d,c){let e=.25;c&&(e=1);return a<b+d?`rgba(0, 100, 0, ${e})`:a<b+2*d?`rgba(255, 165, 0, ${e})`:`rgba(255, 0, 0, ${e})`}findIndexByHour(a,b){for(let d=0;d<a.length;d++)if((new Date(a[d].Date.slice(0,16))).getHours()===b)return d;return-1}updateChartPeriod(a,b){const d=luxon.DateTime;var c=this.chartUpdatePeriod;const e=new Date,g=e.getHours();
e.setMinutes(0,0,0);const k=new Date(e.getTime()-36E5*c);c=new Date(e.getTime()+36E5*c);logger("Fetching period from:["+k+"] to:["+c+"] date=["+e+"]");this.apiService.getOMIEPricesForPeriod(this.formatDate(k),this.formatDate(c)).then(h=>{logger("OMIE Prices:",h);var f=h.prices;h=h.profile;const n=this.findIndexByHour(f,g),q=Math.min(...f.map(m=>m.Price_PT)),l=Math.max(...f.map(m=>m.Price_PT)),p=Math.min(...f.map(m=>m.Cost)),u=Math.max(...f.map(m=>m.Cost));a.data.labels=f.map(m=>d.fromISO(m.Date).toUTC().toFormat("HH"));
a.data.datasets[0].label="Energia OMIE";a.data.datasets[0].data=f.map(m=>m.Price_PT);let t=(l-q)/3;a.data.datasets[0].backgroundColor=f.map((m,r)=>this.getColor(m.Price_PT,q,t,r==n));a.data.datasets[0].borderColor=f.map((m,r)=>r==n?"darkblue":"lightgray");a.update();this.loadEnergyChart(b,f,h,t,p,u,n)}).catch(h=>{console.error("Error:",h)});return e}getMinMaxDate(a){if(0===a.length)return{minDate:null,maxDate:null};let b=new Date(a[0].Date),d=new Date(a[0].Date);for(const c of a)a=new Date(c.Date),
a<b&&(b=a),a>d&&(d=a);return{minDate:b,maxDate:d}}processEnergyData(a){let b={vazioCost:0,cheioCost:0,pontaCost:0,totalCost:0,vazioEnergy:0,cheioEnergy:0,pontaEnergy:0,vazioAvgPrice:0,cheioAvgPrice:0,pontaAvgPrice:0,totalEnergy:0,globalAvgPrice:0};a.forEach(d=>{null!==d.Vazio&&(b.vazioCost+=d.Cost,b.vazioEnergy+=d.Vazio);null!==d.Cheio&&(b.cheioCost+=d.Cost,b.cheioEnergy+=d.Cheio);null!==d.Ponta&&(b.pontaCost+=d.Cost,b.pontaEnergy+=d.Ponta);b.totalCost+=d.Cost});b.vazioAvgPrice=b.vazioEnergy?b.vazioCost/
b.vazioEnergy:0;b.cheioAvgPrice=b.cheioEnergy?b.cheioCost/b.cheioEnergy:0;b.pontaAvgPrice=b.pontaEnergy?b.pontaCost/b.pontaEnergy:0;b.totalEnergy=b.vazioEnergy+b.cheioEnergy+b.pontaEnergy;b.globalAvgPrice=b.totalCost/b.totalEnergy;return b}getTotalEnergyCost(a){return a.reduce((b,d)=>({sumEnergy:b.sumEnergy+d.Energy,sumCost:b.sumCost+d.Cost,sumVazio:b.sumVazio+d.Vazio,sumCheio:b.sumCheio+d.Cheio,sumPonta:b.sumPonta+d.Ponta}),{sumEnergy:0,sumCost:0,sumVazio:0,sumCheio:0,sumPonta:0})}updateChartAnalysis(a,
b){document.getElementById("title_consumo_real").textContent="Consumo Real :";const d=this.getTotalEnergyCost(b);var c=this.processEnergyData(b);const e=this.getMinMaxDate(b);var g=this.getMinMaxDate(this.lastRealDataFetch);d.sumEnergy.toFixed(2);document.getElementById("analysis-periodo-start").value=this.formatDate(g.minDate,!0);document.getElementById("analysis-periodo-end").value=this.formatDate(g.maxDate,!0);document.getElementById("analysis-custo-total").textContent=`${c.totalCost.toFixed(2)}`+
" \u20ac";document.getElementById("analysis-custo-preco-medio").textContent=`${c.globalAvgPrice.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-energia-vazio-total").textContent=`${c.vazioEnergy.toFixed(2)} `+" kWh ("+`${c.vazioCost.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-cheio-total").textContent=`${c.cheioEnergy.toFixed(2)} `+" kWh ("+`${c.cheioCost.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-ponta-total").textContent=`${c.pontaEnergy.toFixed(2)} `+
" kWh ("+`${c.pontaCost.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-total").textContent=`${c.totalEnergy.toFixed(2)} `+" kWh";document.getElementById("analysis-custo-preco-medio-vazio").textContent=`${c.vazioAvgPrice.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-preco-medio-cheio").textContent=`${c.cheioAvgPrice.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-preco-medio-ponta").textContent=`${c.pontaAvgPrice.toFixed(6)} `+" \u20ac/kWh";
document.getElementById("title_profile").textContent="Curva Perfil "+CONFIG.profile+" ..... Em Processamento ....";c=document.getElementById("analysis-contador-vazio").value;g=document.getElementById("analysis-contador-cheio").value;var k=document.getElementById("analysis-contador-ponta").value;0==c&&(c=d.sumVazio.toFixed(2),document.getElementById("analysis-contador-vazio").value=c);0==g&&(g=d.sumCheio.toFixed(2),document.getElementById("analysis-contador-cheio").value=g);0==k&&(k=d.sumPonta.toFixed(2),
document.getElementById("analysis-contador-ponta").value=k);this.fetchProfileDataBasedOnManual(e,c,g,k);this.lastRealDataDisplay=b;document.getElementById("switch-chart").checked&&(this.isRealConsumption=!0,this.loadDataOnAnalysisChart(a,this.lastRealDataDisplay))}aggregateByHour(a){const b={};a.forEach(d=>{var c=new Date(d.Date);c=(new Date(c.getFullYear(),c.getMonth(),c.getDate(),c.getHours())).toISOString();b[c]||(b[c]={Date:c,Energy:0,Vazio:null,Cheio:null,Ponta:null});null!=d.Vazio&&(b[c].Vazio+=
d.Vazio);null!=d.Cheio&&(b[c].Cheio+=d.Cheio);null!=d.Ponta&&(b[c].Ponta+=d.Ponta);b[c].Energy+=d.Energy;var e=[b[c].Vazio,b[c].Cheio,b[c].Ponta].filter(g=>null!==g);0<e.length&&(d=Math.max(...e),e=Math.min(...e),b[c].Vazio==d?b[c].Cheio==e?(b[c].Vazio+=e,b[c].Cheio=null):b[c].Ponta==e&&(b[c].Vazio+=e,b[c].Ponta=null):b[c].Cheio==d?b[c].Vazio==e?(b[c].Cheio+=e,b[c].Vazio=null):b[c].Ponta==e&&(b[c].Cheio+=e,b[c].Ponta=null):b[c].Ponta==d&&(b[c].Vazio==e?(b[c].Ponta+=e,b[c].Vazio=null):b[c].Cheio==
e&&(b[c].Ponta+=e,b[c].Cheio=null)))});return Object.values(b)}loadEnergyChart(a,b,d,c,e,g,k){const h=luxon.DateTime;c=(g-e)/3;var f=this.aggregateByHour(d);d={type:"bar",label:"Energia "+(CONFIG.supplier.toLowerCase().includes("coopernico")?"Coopernico":"LuzBoa"),data:b.map(l=>l.Cost),backgroundColor:b.map((l,p)=>this.getColor(l.Cost,e,c,p==k)),borderColor:b.map((l,p)=>p==k?"darkblue":"lightgray"),borderWidth:1,yAxisID:"yAxisCost"};g={type:"line",label:"Vazio",data:f.map(l=>l.Vazio),backgroundColor:"rgba(84, 234, 9, 0.8)",
borderWidth:1,yAxisID:"yAxisConsumo"};var n={type:"line",label:"Cheio",data:f.map(l=>l.Cheio),backgroundColor:"rgba(15, 225, 225, 0.9)",borderWidth:1,yAxisID:"yAxisConsumo"};f={type:"line",label:"Ponta",data:f.map(l=>l.Ponta),backgroundColor:"rgba(15, 120, 225, 0.9)",borderWidth:1,yAxisID:"yAxisConsumo"};var q={};q="true"===CONFIG.curva_perfil_c.toLowerCase()?{labels:b.map(l=>h.fromISO(l.Date).toUTC().toFormat("HH")),datasets:[d,g,n,f]}:{labels:b.map(l=>h.fromISO(l.Date).toUTC().toFormat("HH")),datasets:[d]};
a.data=q;a.options={responsive:!0,maintainAspectRatio:!1,scales:{x:{title:{display:!0,text:"Hora"}},yAxisConsumo:{position:"right",display:!1,title:{display:!1,text:"Consumo (kWh)"}},yAxisCost:{position:"left",title:{display:!0,text:"Custo (\u20ac/kWh)"}}},plugins:{tooltip:{callbacks:{title:function(l){return"Hora: "+l[0].label+":00"},label:function(l){let p="";return p=0==l.datasetIndex?p+("Custo: "+Number(l.parsed.y).toFixed(4)+" \u20ac"):p+("Quantidade: "+Number(l.parsed.y).toFixed(4)+" kWh")}}}}};
a.update();a.resize()}loadDataOnAnalysisChart(a,b){var d={type:"line",label:"Consumo Vazio",data:b.map(f=>f.Vazio),backgroundColor:"rgba(84, 234, 9, 0.8)",borderWidth:1,yAxisID:"yAxisConsumo"},c={type:"line",label:"Consumo Cheio",data:b.map(f=>f.Cheio),backgroundColor:"rgba(15, 225, 225, 0.9)",borderWidth:1,yAxisID:"yAxisConsumo"},e={type:"line",label:"Consumo Ponta",data:b.map(f=>f.Ponta),backgroundColor:"rgba(15, 120, 225, 0.9)",borderWidth:1,yAxisID:"yAxisConsumo"},g={type:"bar",label:"Custo",
data:b.map(f=>f.Cost),backgroundColor:"rgba(241, 163, 6, 0.5)",borderColor:"rgba(241, 163, 6, 0.5)",borderWidth:1,yAxisID:"yAxisCost"};const k={pan:{enabled:!0,mode:"x"},zoom:{wheel:{enabled:!0},pinch:{enabled:!0},drag:{enabled:!1},mode:"x"}};var h={responsive:!0,maintainAspectRatio:!1,scales:{yAxisConsumo:{position:"left",title:{display:!0,text:"Consumo (kWh)"}},yAxisCost:{position:"right",title:{display:!0,text:"Custo (\u20ac/kWh)"}}},plugins:{zoom:k,title:{display:!0,position:"bottom",text:f=>
"Zoom: "+((k.zoom.wheel.enabled?"enabled":"disabled")+" ("+f.chart.getZoomLevel()+"x), Pan: ")+(k.pan.enabled?"enabled":"disabled")},tooltip:{callbacks:{label:function(f){return 3==f.datasetIndex?"Custo: "+Number(f.parsed.y).toFixed(4)+" \u20ac":"Quantidade: "+Number(f.parsed.y).toFixed(4)+" kWh"}}}}};b={labels:b.map(f=>f.Date),datasets:[d,c,e,g]};a.data=b;a.options=h;a.update();a.resize()}setupSliderForData(a,b){this.getMinMaxDate(b);var d=b.length-1;this.analysisChart=a;this.lastRealDataDisplay=
this.lastRealDataFetch=b;document.getElementById("analysis-slider-periodo").textContent=b[0].Date+"    -    "+b[d].Date;b={id:"slider_chart",enabled:!0,tooltip:"hide",tooltip_split:!1,min:0,max:d,step:1,value:[0,d]};slider.getElement();slider.destroy();slider=new Slider("#analysis-data-range",b);slider.enable();d=this.lastRealDataDisplay.slice(0,d+1);this.updateChartAnalysis(a,d);slider.on("slideStop",this.onSlideStop);slider.on("change",this.onSlideChange)}onSlideChange(a){var b=a.newValue;if(Array.isArray(b)){const d=
priceTrackerApp.lastRealDataFetch;a=b[0];b=b[1];document.getElementById("analysis-slider-periodo").textContent=d[a].Date+"    -    "+d[b].Date}}onSlideStop(a){const b=priceTrackerApp.lastRealDataFetch.slice(a[0],a[1]+1);priceTrackerApp.updateChartAnalysis(priceTrackerApp.analysisChart,b);document.getElementById("title_profile").textContent="Curva Perfil "+CONFIG.profile+" ..... Em Processamento ....";logger("SLIDING",a,b)}getCurrentDataForSlider(){var a=this.lastRealDataFetch,b=priceTrackerApp.getMinMaxDate(a);
return[a,priceTrackerApp.formatDate(b.minDate,!0),priceTrackerApp.formatDate(b.maxDate,!0)]}fetchProfileDataBasedOnManual(a,b,d,c){apiService.getEstimationProfileManual(this.formatDate(a.minDate),this.formatDate(a.maxDate),b,d,c,0,"json").then(e=>{const g=e.Total_Cost/e.Total_energy;document.getElementById("analysis-energia-profile-vazio-total").textContent=`${e.Energy_Vazio.toFixed(2)} `+" kWh ("+`${e.Cost_Vazio.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-cheio-total").textContent=
`${e.Energy_Cheio.toFixed(2)} `+" kWh ("+`${e.Cost_Cheio.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-ponta-total").textContent=`${e.Energy_Ponta.toFixed(2)} `+" kWh ("+`${e.Cost_Ponta.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-total").textContent=`${e.Total_energy.toFixed(2)} `+" kWh";document.getElementById("analysis-custo-profile-total").textContent=`${e.Total_Cost.toFixed(2)} `+" \u20ac";document.getElementById("analysis-custo-profile-preco-medio").textContent=
`${g.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-vazio").textContent=`${e.Vazio_avg_price_cost.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-cheio").textContent=`${e.Cheio_avg_price_cost.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-ponta").textContent=`${e.Ponta_avg_price_cost.toFixed(6)} `+" \u20ac/kWh";""!=e.records&&(this.lastEstimateDataFetch=e.records);document.getElementById("switch-chart").checked||
null===this.lastEstimateDataFetch||priceTrackerApp.loadDataOnAnalysisChart(priceChartAnalysis,priceTrackerApp.lastEstimateDataFetch);"luzboa-spot"==CONFIG.supplier?document.getElementById("title_profile").textContent="C\u00e1lculo do Consumo (Per\u00edodo) :":document.getElementById("title_profile").textContent="Curva Perfil "+CONFIG.profile}).catch(e=>{console.error("fetchProfileDataBasedOnManual Error:",e)})}fetchProfileDataBasedOnFile(a,b){apiService.getEstimationProfile(this.formatDate(a.minDate),
this.formatDate(a.maxDate),b,"json").then(d=>{const c=d.Total_Cost/d.Total_energy;document.getElementById("analysis-energia-profile-vazio-total").textContent=`${d.Energy_Vazio.toFixed(2)} `+" kWh ("+`${d.Cost_Vazio.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-cheio-total").textContent=`${d.Energy_Cheio.toFixed(2)} `+" kWh ("+`${d.Cost_Cheio.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-ponta-total").textContent=`${d.Energy_Ponta.toFixed(2)} `+
" kWh ("+`${d.Cost_Ponta.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-total").textContent=`${d.Total_energy.toFixed(2)} `+" kWh";document.getElementById("analysis-custo-profile-total").textContent=`${d.Total_Cost.toFixed(2)} `+" \u20ac";document.getElementById("analysis-custo-profile-preco-medio").textContent=`${c.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-vazio").textContent=`${d.Vazio_avg_price_cost.toFixed(4)} `+" \u20ac/kWh";
document.getElementById("analysis-custo-profile-preco-medio-cheio").textContent=`${d.Cheio_avg_price_cost.toFixed(4)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-ponta").textContent=`${d.Ponta_avg_price_cost.toFixed(4)} `+" \u20ac/kWh";""!=d.records&&(this.lastEstimateDataDisplay=this.lastEstimateDataFetch=d.records);0==document.getElementById("switch-chart").checked&&(this.isRealConsumption=!1,priceTrackerApp.loadDataOnAnalysisChart(priceChartAnalysis,priceTrackerApp.lastEstimateDataFetch));
document.getElementById("title_profile").textContent="Curva Perfil "+CONFIG.profile}).catch(d=>{console.error("fetchProfileDataBasedOnFile Error:",d)})}}var apiService=null,priceTrackerApp=null,priceChart,priceChartNet,priceChartAnalysis=null,slider=null,timerId,file=null,sample="";
document.addEventListener("DOMContentLoaded",()=>{var a=localStorage.getItem("config");a&&(a=JSON.parse(a),document.getElementById("config-perfil").value=void 0===a.curva_perfil_c?CONFIG.curva_perfil_c:a.curva_perfil_c,document.getElementById("config-hours").value=void 0===a.hours?CONFIG.chart_update_period:a.hours,document.getElementById("config-tariff").value=void 0===a.tariff?CONFIG.tariff:a.tariff,document.getElementById("config-supplier").value=void 0===a.supplier?CONFIG.supplier:a.supplier,
document.getElementById("config-year").value=void 0===a.year?CONFIG.year:a.year,document.getElementById("config-eot-key").value=void 0===a.configEotKey?CONFIG.EoTKey:a.configEotKey,document.getElementById("config-cycle-day").value=void 0===a.cycle_day?CONFIG.cycle_day:a.cycle_day,document.getElementById("config-profile").value=void 0===a.profile?CONFIG.profile:a.profile,document.getElementById("config-refresh-rate").value=void 0===a.chart_update_interval?CONFIG.chart_update_interval:a.chart_update_interval,
CONFIG.chart_update_interval=void 0===a.chart_update_interval?CONFIG.chart_update_interval:a.chart_update_interval,CONFIG.chart_update_period=void 0===a.hours?CONFIG.chart_update_period:a.hours,CONFIG.chart_update_period_net=void 0===a.hours?CONFIG.chart_update_period_net:a.hours,CONFIG.tariff=void 0===a.tariff?CONFIG.tariff:a.tariff,CONFIG.supplier=void 0===a.supplier?CONFIG.supplier:a.supplier,CONFIG.year=void 0===a.year?CONFIG.year:a.year,CONFIG.EoTKey=void 0===a.configEotKey?CONFIG.EoTKey:a.configEotKey,
CONFIG.curva_perfil_c=void 0===a.curva_perfil_c?CONFIG.curva_perfil_c:a.curva_perfil_c,CONFIG.cycle_day=void 0===a.cycle_day?CONFIG.cycle_day:a.cycle_day,CONFIG.profile=void 0===a.profile?CONFIG.profile:a.profile,logger("Loaded CONFIG: ",CONFIG));a=window.location.protocol;var b=window.location.hostname;"localhost"===b||"file:"===window.location.protocol?(CONFIG.api_url="http://localhost:5000",CONFIG.allowDebug=!0):(CONFIG.api_url=`${a}//${b}${":5000"}`,CONFIG.allowDebug=!1);logger("Starting the app... ADDRESS:",
CONFIG.api_url);apiService=new ApiService(CONFIG.api_url);priceTrackerApp=new PriceTracker(apiService,CONFIG.chart_update_period);[priceChart,priceChartNet,priceChartAnalysis]=priceTrackerApp.initCharts();document.getElementById("consumo-browse-file").addEventListener("change",handleFileInputChange);document.getElementById("analysis-contador-refresh").addEventListener("click",handleAnaliseRefreshContador);document.getElementById("switch-chart").addEventListener("change",handleSwitchChange_Chart);
document.getElementById("configForm").addEventListener("submit",handleStoreConfig);document.getElementById("title_profile").textContent="Curva Perfil "+CONFIG.profile;slider=new Slider("#analysis-data-range",{enabled:!1});priceTrackerApp.setAnalysisPageforSupplier(CONFIG.supplier,CONFIG.tariff);priceTrackerApp.fetchServerData(priceChart,priceChartNet,force=!0);resetTimer();document.getElementById("btn-reset-zoom").addEventListener("click",function(){priceChartAnalysis.resetZoom()});document.getElementById("btn-zoom-in").addEventListener("click",
function(){priceChartAnalysis.zoom({x:1.1})});document.getElementById("btn-zoom-out").addEventListener("click",function(){priceChartAnalysis.zoom({x:.9})});document.getElementById("btn-pan-right").addEventListener("click",function(){priceChartAnalysis.pan({x:-100},void 0,"default")});document.getElementById("btn-pan-left").addEventListener("click",function(){priceChartAnalysis.pan({x:100},void 0,"default")});document.getElementById("btn-resample-15m").addEventListener("click",function(){sample="";
file&&uploadFile(file)});document.getElementById("btn-resample-1h").addEventListener("click",function(){sample="1H";file&&uploadFile(file)});document.getElementById("btn-resample-1d").addEventListener("click",function(){sample="1D";file&&uploadFile(file)});document.getElementById("btn-resample-1w").addEventListener("click",function(){sample="1W";file&&uploadFile(file)});a=["analysis-contador-vazio","analysis-contador-cheio","analysis-contador-ponta"];for(var d of a){const c=document.getElementById(d);
c.addEventListener("change",function(){validateInput(c)})}a=new Date;d=new Date(a.getFullYear(),a.getMonth(),a.getDate()-2,0,0);a=new Date(a.getFullYear(),a.getMonth(),a.getDate()-1,23,59);b=document.getElementById("analysis-periodo-start");flatpickr(b,{enableTime:!0,dateFormat:"Y-m-d H:i",defaultDate:d,time_24hr:!0});d=document.getElementById("analysis-periodo-end");flatpickr(d,{enableTime:!0,dateFormat:"Y-m-d H:i",defaultDate:a,time_24hr:!0})});
function logger(...a){var b=!1;const d=localStorage.getItem("config");d&&(b=JSON.parse(d),b=void 0===b.debug?CONFIG.allowDebug:b.debug);b&&console.log(...a)}function resetTimer(){timerId&&clearInterval(timerId);timerId=setInterval(()=>{priceTrackerApp.fetchServerData(priceChart,priceChartNet)},6E4*CONFIG.chart_update_interval)}
function handleStoreConfig(a){a.preventDefault();a=document.getElementById("config-hours").value;const b=document.getElementById("config-perfil").value,d=document.getElementById("config-tariff").value,c=document.getElementById("config-supplier").value,e=document.getElementById("config-year").value,g=document.getElementById("config-eot-key").value,k=document.getElementById("config-cycle-day").value,h=document.getElementById("config-profile").value,f=document.getElementById("config-refresh-rate").value,
n=CONFIG.api_url,q={apiUrl:n,hours:a,tariff:d,year:e,configEotKey:g,supplier:c,curva_perfil_c:b,cycle_day:k,profile:h,chart_update_interval:f};CONFIG.chart_update_period=a;CONFIG.chart_update_period_net=a;CONFIG.tariff=d;CONFIG.supplier=c;CONFIG.year=e;CONFIG.EoTKey=g;CONFIG.curva_perfil_c=b;CONFIG.cycle_day=k;CONFIG.profile=h;CONFIG.chart_update_interval=f;priceTrackerApp.apiService=new ApiService(n);priceTrackerApp.chartUpdatePeriod=a;priceTrackerApp.chartUpdatePeriodNet=a;localStorage.setItem("config",
JSON.stringify(q));logger("Configuration saved!",CONFIG);resetTimer();priceTrackerApp.setAnalysisPageforSupplier(CONFIG.supplier,CONFIG.tariff);priceTrackerApp.fetchServerData(priceChart,priceChartNet,force=!0);(new bootstrap.Tab(document.getElementById("home-tab"))).show()}
function handleSwitchChange_Chart(a){a.target.checked?null!=priceTrackerApp.lastRealDataFetch&&(priceTrackerApp.isRealConsumption=!0,priceTrackerApp.loadDataOnAnalysisChart(priceChartAnalysis,priceTrackerApp.lastRealDataDisplay)):null!=priceTrackerApp.lastEstimateDataFetch&&(priceTrackerApp.isRealConsumption=!1,priceTrackerApp.loadDataOnAnalysisChart(priceChartAnalysis,priceTrackerApp.lastEstimateDataFetch))}
function handleAnaliseRefreshContador(a){if("luzboa-spot"==CONFIG.supplier){const g=CONFIG.tariff;a={simples:["analysis-contador-cheio"],bi:["analysis-contador-vazio","analysis-contador-cheio"],tri:["analysis-contador-vazio","analysis-contador-cheio","analysis-contador-ponta"]};var b=Object.keys(a).find(f=>g.toLowerCase().includes(f));const k=a[b]||[];a=document.getElementById("analysisForm");let h=!0;document.querySelectorAll("[data-validate]").forEach(f=>{if(k.includes(f.id)){const n=parseFloat(f.value);
isNaN(n)||0>=n?(f.classList.add("is-invalid"),h=!1):f.classList.remove("is-invalid")}});a.classList.add("was-validated");if(h){a=new Date(document.getElementById("analysis-periodo-start").value);b=new Date(document.getElementById("analysis-periodo-end").value);var d={minDate:a,maxDate:b};a=document.getElementById("analysis-contador-vazio").value.replace(/,/g,".");b=document.getElementById("analysis-contador-cheio").value.replace(/,/g,".");var c=document.getElementById("analysis-contador-ponta").value.replace(/,/g,
".");document.getElementById("title_profile").textContent="C\u00e1lculo do Consumo (Per\u00edodo) : ..... Em Processamento ....";priceTrackerApp.fetchProfileDataBasedOnManual(d,a,b,c)}}else if(null!=priceTrackerApp.lastRealDataFetch){document.getElementById("title_profile").textContent="Curva Perfil "+CONFIG.profile+" ..... Em Processamento ....";d=priceTrackerApp.getMinMaxDate(priceTrackerApp.lastRealDataDisplay);var e=priceTrackerApp.getTotalEnergyCost(priceTrackerApp.lastRealDataDisplay);a=document.getElementById("analysis-contador-vazio").value;
b=document.getElementById("analysis-contador-cheio").value;c=document.getElementById("analysis-contador-ponta").value;0==a&&(a=e.sumVazio.toFixed(2),document.getElementById("analysis-contador-vazio").value=a);0==b&&(b=e.sumCheio.toFixed(2),document.getElementById("analysis-contador-cheio").value=b);0==c&&(c=e.sumPonta.toFixed(2),document.getElementById("analysis-contador-ponta").value=c);priceTrackerApp.fetchProfileDataBasedOnManual(d,a,b,c)}}
async function handleFileInputChange(a){a.target.files&&0!==a.target.files.length&&(file=a.target.files[0])&&uploadFile(file)}
async function uploadFile(a){if(a)try{document.getElementById("title_consumo_real").textContent="Consumo Real : ..... Em Processamento ....";showAlert("Aguarde enquanto os dados s\u00e3o processados...");const b=document.getElementById("consumo-tipo").value.trim(),d=document.getElementById("analisys-provider").innerHTML.trim();logger("File selected:",a.name,"Provider:",d,"ColumnType:",b);const c=await apiService.uploadEnergyFile("json",d,a,b);logger("UploadEnergyFile: File uploaded successfully:",
c);document.getElementById("switch-chart").checked=!0;""!=c.consumo&&(document.getElementById("analysis-contador-vazio").value=c.consumo.Vazio,document.getElementById("analysis-contador-cheio").value=c.consumo.Cheias,document.getElementById("analysis-contador-ponta").value=c.consumo.Ponta);priceTrackerApp.setupSliderForData(priceChartAnalysis,c.records);hideAlert()}catch(b){showAlert("Erro no processamento do ficheiro. Verifique se est\u00e1 a usar o ficheiro correto..."),console.error("Error uploading file:",
b)}}function updateDropDownProviderTitle(a,b){a.preventDefault();document.getElementById("analisys-provider").innerHTML=b.innerHTML}function updateDropDownDivisor(a,b){a.preventDefault();document.getElementById("analisys-divisor").innerHTML=b.innerHTML;CONFIG.divisor="Auto"==b.innerHTML?0:b.innerHTML}function showAlert(a){const b=document.getElementById("processingAlert");b.querySelector("strong").textContent=a;b.style.display="block";new bootstrap.Alert(b)}
function hideAlert(){document.getElementById("processingAlert").style.display="none"}function validateInput(a){const b=parseFloat(a.value);if(isNaN(b)||0>b)return a.classList.add("is-invalid"),!1;a.classList.remove("is-invalid");return!0}function updateDropDownTariffTitle(a,b){a.preventDefault();document.getElementById("current-tarifario").innerHTML=b.innerHTML};
