var CONFIG={api_url:"",tariff:"Tri-Horario-Semanal",year:"2023",curva_perfil_c:"True",supplier:"coopernico-base",chart_update_interval:6E4,chart_update_period:12,chart_update_period_net:12,EoTKey:"XXXXXXXXXX",cycle_day:8,allowDebug:!1};
class ApiService{constructor(b){this.baseUrl=b}async getCurrentPrice(b,a,d,c){try{const e=await fetch(`${this.baseUrl}/getCurrentPrice?tariff=${a}&year=${d}&supplier=${b}&cycle_day=${c}`);if(!e.ok)throw Error(`HTTP error: ${e.status}`);return await e.json()}catch(e){throw console.error(`Error fetching current price: ${e}`),e;}}async getOMIEPricesForPeriod(b,a,d,c,e,f){try{const h=await fetch(`${this.baseUrl}/getOMIEPricesForPeriod?tariff=${a}&supplier=${b}&year=${d}&cycle_day=${c}&start_date=${e}&end_date=${f}`);
if(!h.ok)throw Error(`HTTP error: ${h.status}`);return await h.json()}catch(h){throw console.error(`Error fetching OMIE prices for period: ${h}`),h;}}async uploadEnergyFile(b,a,d,c,e,f,h){b=`${this.baseUrl}/uploadEnergyFile?supplier=${b}&tariff=${a}&year=${d}&cycle_day=${c}&format=${e}&provider=${f}`;a=new FormData;a.append("file",h);h={method:"POST",body:a};try{const l=await fetch(b,h);if(!l.ok)throw Error(`HTTP error! status: ${l.status}`);return await l.json()}catch(l){throw console.error("Error uploading file:",
l),l;}}async getEstimationProfile(b,a,d,c,e,f,h,l="none"){try{const g=await fetch(`${this.baseUrl}/getEstimationProfile?supplier=${b}&tariff=${a}&year=${d}&cycle_day=${c}&start_date=${e}&end_date=${f}&total_energy=${h}&records=${l}`);if(!g.ok)throw Error(`HTTP error: ${g.status}`);return await g.json()}catch(g){throw console.error(`Error fetching estimation profile: ${g}`),g;}}async getEstimationProfileManual(b,a,d,c,e,f,h,l,g,p=0,q="none"){try{const k=await fetch(`${this.baseUrl}/getEstimationProfileManual?supplier=${b}&tariff=${a}&year=${d}&cycle_day=${c}&start_date=${e}&end_date=${f}&total_vazio=${h}&total_cheio=${l}&total_ponta=${g}&lagHour=${p}&records=${q}`);
if(!k.ok)throw Error(`HTTP error: ${k.status}`);return await k.json()}catch(k){throw console.error(`Error fetching estimation profile: ${k}`),k;}}async getEOTData(b,a,d,c,e){try{const f=await fetch(`${this.baseUrl}/getEOTData?supplier=${b}&tariff=${a}&year=${d}&cycle_day=${c}&key=${e}`);if(!f.ok)throw Error(`HTTP error: ${f.status}`);return await f.json()}catch(f){throw console.error(`Error fetching EOT data: ${f}`),f;}}}
class PriceTracker{constructor(b,a){this.apiService=b;this.chartUpdatePeriod=a;this.lastUpdateChart=new Date;this.analysisChart=this.lastEstimateDataDisplay=this.lastRealDataDisplay=this.lastEstimateDataFetch=this.lastRealDataFetch=null;this.isRealConsumption=!0;this.zoomOptions={pan:{enabled:!0,mode:"x"},zoom:{wheel:{enabled:!0},pinch:{enabled:!0},drag:{enabled:!1},mode:"x"}};this.chartConfig={type:"bar",data:{labels:[],datasets:[{label:"Energia",data:[],borderColor:"rgba(75, 192, 192, 1)",backgroundColor:"rgba(75, 192, 192, 0.2)",
borderWidth:1,tension:.1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{title:{display:!0,text:"Hora"}},y:{title:{display:!0,text:"Pre\u00e7o"}}},plugins:{tooltip:{callbacks:{title:function(d){return"Hora: "+d[0].label+":00"},label:function(d){let c=d.dataset.label||"";c&&="Pre\u00e7o: ";return c+=Number(d.parsed.y).toFixed(2)+" \u20ac/MWh"}}}}}};this.chartConfigNet={type:"bar",data:{labels:[],datasets:[{label:"Energia",data:[],borderColor:"rgba(75, 192, 192, 1)",backgroundColor:"rgba(75, 192, 192, 0.2)",
borderWidth:1,tension:.1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{title:{display:!0,text:"Hora"}},y:{title:{display:!0,text:"Pre\u00e7o"}}},plugins:{tooltip:{callbacks:{title:function(d){return"Hora: "+d[0].label+":00"},label:function(d){let c=d.dataset.label||"";c&&="Pre\u00e7o: ";return c+=Number(d.parsed.y).toFixed(4)+" \u20ac/kWh"}}}}}}}initCharts(){var b=document.getElementById("price-chart");b=new Chart(b,this.chartConfig);var a=document.getElementById("price-chart-net");
a=new Chart(a,this.chartConfigNet);var d=document.getElementById("price-chart-analysis");d=new Chart(d,{type:"line"});return[b,a,d]}formatTitleCase(b){return b.toLowerCase().split("-").map(a=>a.charAt(0).toUpperCase()+a.slice(1)).join("-")}fetchServerData(b,a,d=!1){logger("Fetching Price..."+this.lastUpdateChart);this.apiService.getCurrentPrice(CONFIG.supplier,CONFIG.tariff,CONFIG.year,CONFIG.cycle_day).then(c=>{logger("Current Price:",c);const e=new Date;var f=0===c["TAR Period"].dst?" / Inverno":
" / Ver\u00e3o";f=0===c["TAR Period"].dias?"Dia de Semana"+f:1===c["TAR Period"].dias?"S\u00e1bado"+f:"Domingo"+f;const h=c["TAR Period"].periodo+": "+c["TAR Period"].start+" - "+c["TAR Period"].end,l=c["Cycle Period"].start.substring(0,10);document.getElementById("current-price-omie").textContent=`${c["OMIE price"].toFixed(2)} \u20ac/MWh`;document.getElementById("current-price-net").textContent=`${c["net price"].toFixed(4)} \u20ac/kWh`;document.getElementById("current-cycle_period").textContent=
`${l}`;document.getElementById("current-tarifario").textContent=`${c.Tariff} `;document.getElementById("current-supplier").textContent=`${this.formatTitleCase(c.Supplier)} `;document.getElementById("current-dia").textContent=`${f} `;document.getElementById("current-periodo").textContent=`${h} `;document.getElementById("current-time").textContent=e.toLocaleTimeString("en-US",{hour12:!1})}).catch(c=>{console.error("Error:",c)});""===CONFIG.EoTKey||/^X*$/.test(CONFIG.EoTKey)?(document.getElementById("current-power").textContent=
"N/A",document.getElementById("current-consumo-hora").textContent="N/A"):this.apiService.getEOTData(CONFIG.supplier,CONFIG.tariff,CONFIG.year,CONFIG.cycle_day,CONFIG.EoTKey).then(c=>{logger("EoT Data:",c);const e=c.power,f=c.energy_total;c=c.total_cost;document.getElementById("current-power").textContent=`${e} Watts `;document.getElementById("current-consumo-hora").textContent=`${f.toFixed(2)} kWh (${c.toFixed(4)} \u20ac)`}).catch(c=>{console.error("Error:",c)});if((new Date).getHours()!==this.lastUpdateChart.getHours()||
1==d)this.lastUpdateChart=this.updateChartPeriod(b,a)}formatDate(b,a=!1){const d=b.getFullYear(),c=String(b.getMonth()+1).padStart(2,"0"),e=String(b.getDate()).padStart(2,"0"),f=String(b.getHours()).padStart(2,"0");b=String(b.getMinutes()).padStart(2,"0");return a?`${d}-${c}-${e} ${f}:${b}`:`${d}-${c}-${e}-${f}:${b}`}getColor(b,a,d,c){let e=.25;c&&(e=1);return b<a+d?`rgba(0, 100, 0, ${e})`:b<a+2*d?`rgba(255, 165, 0, ${e})`:`rgba(255, 0, 0, ${e})`}findIndexByHour(b,a){for(let d=0;d<b.length;d++)if((new Date(b[d].Date.slice(0,
16))).getHours()===a)return d;return-1}updateChartPeriod(b,a){const d=luxon.DateTime;var c=this.chartUpdatePeriod;const e=new Date,f=e.getHours();e.setMinutes(0,0,0);const h=new Date(e.getTime()-36E5*c);c=new Date(e.getTime()+36E5*c);logger("Fetching period from:["+h+"] to:["+c+"] date=["+e+"]");this.apiService.getOMIEPricesForPeriod(CONFIG.supplier,CONFIG.tariff,CONFIG.year,CONFIG.cycle_day,this.formatDate(h),this.formatDate(c)).then(l=>{logger("OMIE Prices:",l);var g=l.prices;l=l.profile;const p=
this.findIndexByHour(g,f),q=Math.min(...g.map(m=>m.Price_PT)),k=Math.max(...g.map(m=>m.Price_PT)),n=Math.min(...g.map(m=>m.Cost)),u=Math.max(...g.map(m=>m.Cost));b.data.labels=g.map(m=>d.fromISO(m.Date).toUTC().toFormat("HH"));b.data.datasets[0].label="Energia OMIE";b.data.datasets[0].data=g.map(m=>m.Price_PT);let t=(k-q)/3;b.data.datasets[0].backgroundColor=g.map((m,r)=>this.getColor(m.Price_PT,q,t,r==p));b.data.datasets[0].borderColor=g.map((m,r)=>r==p?"darkblue":"lightgray");b.update();this.loadEnergyChart(a,
g,l,t,n,u,p)}).catch(l=>{console.error("Error:",l)});return e}getMinMaxDate(b){if(0===b.length)return{minDate:null,maxDate:null};let a=new Date(b[0].Date),d=new Date(b[0].Date);for(const c of b)b=new Date(c.Date),b<a&&(a=b),b>d&&(d=b);return{minDate:a,maxDate:d}}processEnergyData(b){let a={vazioCost:0,cheioCost:0,pontaCost:0,totalCost:0,vazioEnergy:0,cheioEnergy:0,pontaEnergy:0,vazioAvgPrice:0,cheioAvgPrice:0,pontaAvgPrice:0,totalEnergy:0,globalAvgPrice:0};b.forEach(d=>{null!==d.Vazio&&(a.vazioCost+=
d.Cost,a.vazioEnergy+=d.Vazio);null!==d.Cheio&&(a.cheioCost+=d.Cost,a.cheioEnergy+=d.Cheio);null!==d.Ponta&&(a.pontaCost+=d.Cost,a.pontaEnergy+=d.Ponta);a.totalCost+=d.Cost});a.vazioAvgPrice=a.vazioEnergy?a.vazioCost/a.vazioEnergy:0;a.cheioAvgPrice=a.cheioEnergy?a.cheioCost/a.cheioEnergy:0;a.pontaAvgPrice=a.pontaEnergy?a.pontaCost/a.pontaEnergy:0;a.totalEnergy=a.vazioEnergy+a.cheioEnergy+a.pontaEnergy;a.globalAvgPrice=a.totalCost/a.totalEnergy;return a}getTotalEnergyCost(b){return b.reduce((a,d)=>
({sumEnergy:a.sumEnergy+d.Energy,sumCost:a.sumCost+d.Cost,sumVazio:a.sumVazio+d.Vazio,sumCheio:a.sumCheio+d.Cheio,sumPonta:a.sumPonta+d.Ponta}),{sumEnergy:0,sumCost:0,sumVazio:0,sumCheio:0,sumPonta:0})}updateChartAnalysis(b,a){document.getElementById("title_consumo_real").textContent="Consumo Real :";const d=this.getTotalEnergyCost(a);var c=this.processEnergyData(a);const e=this.getMinMaxDate(a);var f=this.getMinMaxDate(this.lastRealDataFetch);d.sumEnergy.toFixed(2);document.getElementById("analysis-periodo-start").textContent=
this.formatDate(f.minDate,!0);document.getElementById("analysis-periodo-end").textContent=this.formatDate(f.maxDate,!0);document.getElementById("analysis-custo-total").textContent=`${c.totalCost.toFixed(2)}`+" \u20ac";document.getElementById("analysis-custo-preco-medio").textContent=`${c.globalAvgPrice.toFixed(4)} `+" \u20ac/kWh";document.getElementById("analysis-energia-vazio-total").textContent=`${c.vazioEnergy.toFixed(2)} `+" kWh ("+`${c.vazioCost.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-cheio-total").textContent=
`${c.cheioEnergy.toFixed(2)} `+" kWh ("+`${c.cheioCost.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-ponta-total").textContent=`${c.pontaEnergy.toFixed(2)} `+" kWh ("+`${c.pontaCost.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-total").textContent=`${c.totalEnergy.toFixed(2)} `+" kWh";document.getElementById("analysis-custo-preco-medio-vazio").textContent=`${c.vazioAvgPrice.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-preco-medio-cheio").textContent=
`${c.cheioAvgPrice.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-preco-medio-ponta").textContent=`${c.pontaAvgPrice.toFixed(6)} `+" \u20ac/kWh";document.getElementById("title_profile").textContent='Curva Perfil "C" ..... Em Processamento ....';c=document.getElementById("analysis-contador-vazio").value;f=document.getElementById("analysis-contador-cheio").value;var h=document.getElementById("analysis-contador-ponta").value;0==c&&(c=d.sumVazio.toFixed(2),document.getElementById("analysis-contador-vazio").value=
c);0==f&&(f=d.sumCheio.toFixed(2),document.getElementById("analysis-contador-cheio").value=f);0==h&&(h=d.sumPonta.toFixed(2),document.getElementById("analysis-contador-ponta").value=h);this.fetchProfileDataBasedOnManual(e,c,f,h);this.lastRealDataDisplay=a;document.getElementById("switch-chart").checked&&(this.isRealConsumption=!0,this.loadDataOnAnalysisChart(b,this.lastRealDataDisplay))}aggregateByHour(b){const a={};b.forEach(d=>{var c=new Date(d.Date);c=(new Date(c.getFullYear(),c.getMonth(),c.getDate(),
c.getHours())).toISOString();a[c]||(a[c]={Date:c,Energy:0,Vazio:null,Cheio:null,Ponta:null});null!=d.Vazio&&(a[c].Vazio+=d.Vazio);null!=d.Cheio&&(a[c].Cheio+=d.Cheio);null!=d.Ponta&&(a[c].Ponta+=d.Ponta);a[c].Energy+=d.Energy;var e=[a[c].Vazio,a[c].Cheio,a[c].Ponta].filter(f=>null!==f);0<e.length&&(d=Math.max(...e),e=Math.min(...e),a[c].Vazio==d?a[c].Cheio==e?(a[c].Vazio+=e,a[c].Cheio=null):a[c].Ponta==e&&(a[c].Vazio+=e,a[c].Ponta=null):a[c].Cheio==d?a[c].Vazio==e?(a[c].Cheio+=e,a[c].Vazio=null):
a[c].Ponta==e&&(a[c].Cheio+=e,a[c].Ponta=null):a[c].Ponta==d&&(a[c].Vazio==e?(a[c].Ponta+=e,a[c].Vazio=null):a[c].Cheio==e&&(a[c].Ponta+=e,a[c].Cheio=null)))});return Object.values(a)}loadEnergyChart(b,a,d,c,e,f,h){const l=luxon.DateTime;c=(f-e)/3;var g=this.aggregateByHour(d);d={type:"bar",label:"Energia Coopernico",data:a.map(k=>k.Cost),backgroundColor:a.map((k,n)=>this.getColor(k.Cost,e,c,n==h)),borderColor:a.map((k,n)=>n==h?"darkblue":"lightgray"),borderWidth:1,yAxisID:"yAxisCost"};f={type:"line",
label:"Vazio",data:g.map(k=>k.Vazio),backgroundColor:"rgba(84, 234, 9, 0.8)",borderWidth:1,yAxisID:"yAxisConsumo"};var p={type:"line",label:"Cheio",data:g.map(k=>k.Cheio),backgroundColor:"rgba(15, 225, 225, 0.9)",borderWidth:1,yAxisID:"yAxisConsumo"};g={type:"line",label:"Ponta",data:g.map(k=>k.Ponta),backgroundColor:"rgba(15, 120, 225, 0.9)",borderWidth:1,yAxisID:"yAxisConsumo"};var q={};q="true"===CONFIG.curva_perfil_c.toLowerCase()?{labels:a.map(k=>l.fromISO(k.Date).toUTC().toFormat("HH")),datasets:[d,
f,p,g]}:{labels:a.map(k=>l.fromISO(k.Date).toUTC().toFormat("HH")),datasets:[d]};b.data=q;b.options={responsive:!0,maintainAspectRatio:!1,scales:{x:{title:{display:!0,text:"Hora"}},yAxisConsumo:{position:"right",display:!1,title:{display:!1,text:"Consumo (kWh)"}},yAxisCost:{position:"left",title:{display:!0,text:"Custo (\u20ac/kWh)"}}},plugins:{tooltip:{callbacks:{title:function(k){return"Hora: "+k[0].label+":00"},label:function(k){let n="";return n=0==k.datasetIndex?n+("Custo: "+Number(k.parsed.y).toFixed(4)+
" \u20ac"):n+("Quantidade: "+Number(k.parsed.y).toFixed(4)+" kWh")}}}}};b.update();b.resize()}loadDataOnAnalysisChart(b,a){var d={type:"line",label:"Consumo Vazio",data:a.map(g=>g.Vazio),backgroundColor:"rgba(84, 234, 9, 0.8)",borderWidth:1,yAxisID:"yAxisConsumo"},c={type:"line",label:"Consumo Cheio",data:a.map(g=>g.Cheio),backgroundColor:"rgba(15, 225, 225, 0.9)",borderWidth:1,yAxisID:"yAxisConsumo"},e={type:"line",label:"Consumo Ponta",data:a.map(g=>g.Ponta),backgroundColor:"rgba(15, 120, 225, 0.9)",
borderWidth:1,yAxisID:"yAxisConsumo"},f={type:"bar",label:"Custo",data:a.map(g=>g.Cost),backgroundColor:"rgba(241, 163, 6, 0.5)",borderColor:"rgba(241, 163, 6, 0.5)",borderWidth:1,yAxisID:"yAxisCost"};const h={pan:{enabled:!0,mode:"x"},zoom:{wheel:{enabled:!0},pinch:{enabled:!0},drag:{enabled:!1},mode:"x"}};var l={responsive:!0,maintainAspectRatio:!1,scales:{yAxisConsumo:{position:"left",title:{display:!0,text:"Consumo (kWh)"}},yAxisCost:{position:"right",title:{display:!0,text:"Custo (\u20ac/kWh)"}}},
plugins:{zoom:h,title:{display:!0,position:"bottom",text:g=>"Zoom: "+((h.zoom.wheel.enabled?"enabled":"disabled")+" ("+g.chart.getZoomLevel()+"x), Pan: ")+(h.pan.enabled?"enabled":"disabled")},tooltip:{callbacks:{label:function(g){return 3==g.datasetIndex?"Custo: "+Number(g.parsed.y).toFixed(4)+" \u20ac":"Quantidade: "+Number(g.parsed.y).toFixed(4)+" kWh"}}}}};a={labels:a.map(g=>g.Date),datasets:[d,c,e,f]};b.data=a;b.options=l;b.update();b.resize()}setupSliderForData(b,a){this.getMinMaxDate(a);var d=
a.length-1;this.analysisChart=b;this.lastRealDataDisplay=this.lastRealDataFetch=a;document.getElementById("analysis-slider-periodo").textContent=a[0].Date+"    -    "+a[d].Date;a={id:"slider_chart",enabled:!0,tooltip:"hide",tooltip_split:!1,min:0,max:d,step:1,value:[0,d]};slider.getElement();slider.destroy();slider=new Slider("#analysis-data-range",a);slider.enable();d=this.lastRealDataDisplay.slice(0,d+1);this.updateChartAnalysis(b,d);slider.on("slideStop",this.onSlideStop);slider.on("change",this.onSlideChange)}onSlideChange(b){var a=
b.newValue;if(Array.isArray(a)){const d=priceTrackerApp.lastRealDataFetch;b=a[0];a=a[1];document.getElementById("analysis-slider-periodo").textContent=d[b].Date+"    -    "+d[a].Date}}onSlideStop(b){const a=priceTrackerApp.lastRealDataFetch.slice(b[0],b[1]+1);priceTrackerApp.updateChartAnalysis(priceTrackerApp.analysisChart,a);document.getElementById("title_profile").textContent='Curva Perfil "C" ..... Em Processamento ....';logger("SLIDING",b,a)}getCurrentDataForSlider(){var b=this.lastRealDataFetch,
a=priceTrackerApp.getMinMaxDate(b);return[b,priceTrackerApp.formatDate(a.minDate,!0),priceTrackerApp.formatDate(a.maxDate,!0)]}fetchProfileDataBasedOnManual(b,a,d,c){apiService.getEstimationProfileManual(CONFIG.supplier,CONFIG.tariff,CONFIG.year,CONFIG.cycle_day,this.formatDate(b.minDate),this.formatDate(b.maxDate),a,d,c,1,"json").then(e=>{const f=e.Total_Cost/e.Total_energy;document.getElementById("analysis-energia-profile-vazio-total").textContent=`${e.Energy_Vazio.toFixed(2)} `+" kWh ("+`${e.Cost_Vazio.toFixed(2)} `+
" \u20ac)";document.getElementById("analysis-energia-profile-cheio-total").textContent=`${e.Energy_Cheio.toFixed(2)} `+" kWh ("+`${e.Cost_Cheio.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-ponta-total").textContent=`${e.Energy_Ponta.toFixed(2)} `+" kWh ("+`${e.Cost_Ponta.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-total").textContent=`${e.Total_energy.toFixed(2)} `+" kWh";document.getElementById("analysis-custo-profile-total").textContent=
`${e.Total_Cost.toFixed(2)} `+" \u20ac";document.getElementById("analysis-custo-profile-preco-medio").textContent=`${f.toFixed(4)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-vazio").textContent=`${e.Vazio_avg_price_cost.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-cheio").textContent=`${e.Cheio_avg_price_cost.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-ponta").textContent=`${e.Ponta_avg_price_cost.toFixed(6)} `+
" \u20ac/kWh";""!=e.records&&(this.lastEstimateDataFetch=e.records);1!=document.getElementById("switch-chart").checked&&priceTrackerApp.loadDataOnAnalysisChart(priceChartAnalysis,priceTrackerApp.lastEstimateDataFetch);document.getElementById("title_profile").textContent='Curva Perfil "C" :'}).catch(e=>{console.error("fetchProfileDataBasedOnManual Error:",e)})}fetchProfileDataBasedOnFile(b,a){apiService.getEstimationProfile(CONFIG.supplier,CONFIG.tariff,CONFIG.year,CONFIG.cycle_day,this.formatDate(b.minDate),
this.formatDate(b.maxDate),a,"json").then(d=>{const c=d.Total_Cost/d.Total_energy;document.getElementById("analysis-energia-profile-vazio-total").textContent=`${d.Energy_Vazio.toFixed(2)} `+" kWh ("+`${d.Cost_Vazio.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-cheio-total").textContent=`${d.Energy_Cheio.toFixed(2)} `+" kWh ("+`${d.Cost_Cheio.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-ponta-total").textContent=`${d.Energy_Ponta.toFixed(2)} `+
" kWh ("+`${d.Cost_Ponta.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-total").textContent=`${d.Total_energy.toFixed(2)} `+" kWh";document.getElementById("analysis-custo-profile-total").textContent=`${d.Total_Cost.toFixed(2)} `+" \u20ac";document.getElementById("analysis-custo-profile-preco-medio").textContent=`${c.toFixed(4)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-vazio").textContent=`${d.Vazio_avg_price_cost.toFixed(4)} `+" \u20ac/kWh";
document.getElementById("analysis-custo-profile-preco-medio-cheio").textContent=`${d.Cheio_avg_price_cost.toFixed(4)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-ponta").textContent=`${d.Ponta_avg_price_cost.toFixed(4)} `+" \u20ac/kWh";""!=d.records&&(this.lastEstimateDataDisplay=this.lastEstimateDataFetch=d.records);0==document.getElementById("switch-chart").checked&&(this.isRealConsumption=!1,priceTrackerApp.loadDataOnAnalysisChart(priceChartAnalysis,priceTrackerApp.lastEstimateDataFetch));
document.getElementById("title_profile").textContent='Curva Perfil "C" :'}).catch(d=>{console.error("fetchProfileDataBasedOnFile Error:",d)})}}var apiService=null,priceTrackerApp=null,priceChart,priceChartNet,priceChartAnalysis=null,slider=null;
document.addEventListener("DOMContentLoaded",()=>{var b=localStorage.getItem("config");b&&(b=JSON.parse(b),document.getElementById("config-perfil").value=void 0===b.curva_perfil_c?CONFIG.curva_perfil_c:b.curva_perfil_c,document.getElementById("config-hours").value=void 0===b.hours?CONFIG.chart_update_period:b.hours,document.getElementById("config-tariff").value=void 0===b.tariff?CONFIG.tariff:b.tariff,document.getElementById("config-supplier").value=void 0===b.supplier?CONFIG.supplier:b.supplier,
document.getElementById("config-year").value=void 0===b.year?CONFIG.year:b.year,document.getElementById("config-eot-key").value=void 0===b.configEotKey?CONFIG.EoTKey:b.configEotKey,document.getElementById("config-cycle-day").value=void 0===b.cycle_day?CONFIG.cycle_day:b.cycle_day,CONFIG.chart_update_period=void 0===b.hours?CONFIG.chart_update_period:b.hours,CONFIG.chart_update_period_net=void 0===b.hours?CONFIG.chart_update_period_net:b.hours,CONFIG.tariff=void 0===b.tariff?CONFIG.tariff:b.tariff,
CONFIG.supplier=void 0===b.supplier?CONFIG.supplier:b.supplier,CONFIG.year=void 0===b.year?CONFIG.year:b.year,CONFIG.EoTKey=void 0===b.configEotKey?CONFIG.EoTKey:b.configEotKey,CONFIG.curva_perfil_c=void 0===b.curva_perfil_c?CONFIG.curva_perfil_c:b.curva_perfil_c,CONFIG.cycle_day=void 0===b.cycle_day?CONFIG.cycle_day:b.cycle_day,logger("Loaded CONFIG: ",CONFIG));b=window.location.protocol;var a=window.location.hostname;"localhost"===a||"file:"===window.location.protocol?(CONFIG.api_url="http://localhost:5000",
CONFIG.allowDebug=!0):(CONFIG.api_url=`${b}//${a}${":5000"}`,CONFIG.allowDebug=!1);logger("Starting the app... ADDRESS:",CONFIG.api_url);apiService=new ApiService(CONFIG.api_url);priceTrackerApp=new PriceTracker(apiService,CONFIG.chart_update_period);[priceChart,priceChartNet,priceChartAnalysis]=priceTrackerApp.initCharts();document.getElementById("consumo-browse-file").addEventListener("change",handleFileInputChange);document.getElementById("analysis-contador-refresh").addEventListener("click",handleAnaliseRefreshContador);
document.getElementById("switch-chart").addEventListener("change",handleSwitchChange_Chart);document.getElementById("configForm").addEventListener("submit",handleStoreConfig);slider=new Slider("#analysis-data-range",{enabled:!1});priceTrackerApp.fetchServerData(priceChart,priceChartNet,force=!0);setInterval(()=>{priceTrackerApp.fetchServerData(priceChart,priceChartNet)},6E4);document.getElementById("btn-reset-zoom").addEventListener("click",function(){priceChartAnalysis.resetZoom()});document.getElementById("btn-zoom-in").addEventListener("click",
function(){priceChartAnalysis.zoom({x:1.1})});document.getElementById("btn-zoom-out").addEventListener("click",function(){priceChartAnalysis.zoom({x:.9})});document.getElementById("btn-pan-right").addEventListener("click",function(){priceChartAnalysis.pan({x:-100},void 0,"default")});document.getElementById("btn-pan-left").addEventListener("click",function(){priceChartAnalysis.pan({x:100},void 0,"default")});b=["analysis-contador-vazio","analysis-contador-cheio","analysis-contador-ponta"];for(var d of b){const c=
document.getElementById(d);c.addEventListener("change",function(){validateInput(c)})}b=new Date;d=new Date(b.getFullYear(),b.getMonth(),b.getDate()-2,0,0);b=new Date(b.getFullYear(),b.getMonth(),b.getDate()-1,23,59);a=document.getElementById("analysis-periodo-start");flatpickr(a,{enableTime:!0,dateFormat:"Y-m-d H:i",defaultDate:d,time_24hr:!0});d=document.getElementById("analysis-periodo-end");flatpickr(d,{enableTime:!0,dateFormat:"Y-m-d H:i",defaultDate:b,time_24hr:!0})});
function logger(...b){var a=!1;const d=localStorage.getItem("config");d&&(a=JSON.parse(d),a=void 0===a.debug?CONFIG.allowDebug:a.debug);a&&console.log(...b)}
function handleStoreConfig(b){b.preventDefault();b=document.getElementById("config-hours").value;const a=document.getElementById("config-perfil").value,d=document.getElementById("config-tariff").value,c=document.getElementById("config-supplier").value,e=document.getElementById("config-year").value,f=document.getElementById("config-eot-key").value,h=document.getElementById("config-cycle-day").value,l=CONFIG.api_url,g={apiUrl:l,hours:b,tariff:d,year:e,configEotKey:f,supplier:c,curva_perfil_c:a,cycle_day:h};
CONFIG.chart_update_period=b;CONFIG.chart_update_period_net=b;CONFIG.tariff=d;CONFIG.supplier=c;CONFIG.year=e;CONFIG.EoTKey=f;CONFIG.curva_perfil_c=a;CONFIG.cycle_day=h;priceTrackerApp.apiService=new ApiService(l);priceTrackerApp.chartUpdatePeriod=b;priceTrackerApp.chartUpdatePeriodNet=b;localStorage.setItem("config",JSON.stringify(g));logger("Configuration saved!",CONFIG);priceTrackerApp.fetchServerData(priceChart,priceChartNet,force=!0);(new bootstrap.Tab(document.getElementById("home-tab"))).show()}
function handleSwitchChange_Chart(b){b.target.checked?null!=priceTrackerApp.lastRealDataFetch&&(priceTrackerApp.isRealConsumption=!0,priceTrackerApp.loadDataOnAnalysisChart(priceChartAnalysis,priceTrackerApp.lastRealDataDisplay)):null!=priceTrackerApp.lastEstimateDataFetch&&(priceTrackerApp.isRealConsumption=!1,priceTrackerApp.loadDataOnAnalysisChart(priceChartAnalysis,priceTrackerApp.lastEstimateDataFetch))}
function handleAnaliseRefreshContador(b){if(null!=priceTrackerApp.lastRealDataFetch){document.getElementById("title_profile").textContent='Curva Perfil "C" ..... Em Processamento ....';b=priceTrackerApp.getMinMaxDate(priceTrackerApp.lastRealDataDisplay);var a=priceTrackerApp.getTotalEnergyCost(priceTrackerApp.lastRealDataDisplay),d=document.getElementById("analysis-contador-vazio").value,c=document.getElementById("analysis-contador-cheio").value,e=document.getElementById("analysis-contador-ponta").value;
0==d&&(d=a.sumVazio.toFixed(2),document.getElementById("analysis-contador-vazio").value=d);0==c&&(c=a.sumCheio.toFixed(2),document.getElementById("analysis-contador-cheio").value=c);0==e&&(e=a.sumPonta.toFixed(2),document.getElementById("analysis-contador-ponta").value=e);priceTrackerApp.fetchProfileDataBasedOnManual(b,d,c,e)}}
async function handleFileInputChange(b){if(b.target.files&&0!==b.target.files.length&&(b=b.target.files[0]))try{document.getElementById("title_consumo_real").textContent="Consumo Real : ..... Em Processamento ....";showAlert("Aguarde enquanto os dados s\u00e3o processados...");const a=document.getElementById("analisys-provider").innerHTML.trim();logger("File selected:",b.name,"Provider:",a);const d=await apiService.uploadEnergyFile(CONFIG.supplier,CONFIG.tariff,CONFIG.year,CONFIG.cycle_day,"json",
a,b);logger("UploadEnergyFile: File uploaded successfully:",d);document.getElementById("switch-chart").checked=!0;priceTrackerApp.setupSliderForData(priceChartAnalysis,d);hideAlert()}catch(a){showAlert("Erro no processamento do ficheiro. Verifique se est\u00e1 a usar o ficheiro correto..."),console.error("Error uploading file:",a)}}function updateDropDownProviderTitle(b,a){b.preventDefault();document.getElementById("analisys-provider").innerHTML=a.innerHTML}
function showAlert(b){const a=document.getElementById("processingAlert");a.querySelector("strong").textContent=b;a.style.display="block";new bootstrap.Alert(a)}function hideAlert(){document.getElementById("processingAlert").style.display="none"}function validateInput(b){const a=parseFloat(b.value);if(isNaN(a)||0>a)return b.classList.add("is-invalid"),!1;b.classList.remove("is-invalid");return!0};
