var CONFIG={api_url:"",tariff:"Tri-Horario-Semanal",curva_perfil_c:"True",supplier:"coopernico-base",chart_update_interval:10,chart_update_period:23,chart_update_period_net:23,EoTKey:"XXXXXXXXXX",cycle_day:8,profile:"BTN-C",divisor:0,allowDebug:!1};
class ApiService{constructor(a){this.baseUrl=a}async getCurrentPrice(){try{const a=await fetch(`${this.baseUrl}/getCurrentPrice?tariff=${CONFIG.tariff}&supplier=${CONFIG.supplier}&cycle_day=${CONFIG.cycle_day}&profile=${CONFIG.profile}`);if(!a.ok)throw Error(`HTTP error: ${a.status}`);return await a.json()}catch(a){throw console.error(`Error fetching current price: ${a}`),a;}}async getOMIEPricesForPeriod(a,b){try{const c=await fetch(`${this.baseUrl}/getOMIEPricesForPeriod?tariff=${CONFIG.tariff}&supplier=${CONFIG.supplier}&cycle_day=${CONFIG.cycle_day}&profile=${CONFIG.profile}&start_date=${a}&end_date=${b}`);
if(!c.ok)throw Error(`HTTP error: ${c.status}`);return await c.json()}catch(c){throw console.error(`Error fetching OMIE prices for period: ${c}`),c;}}async uploadEnergyFile(a,b,c,d){a=`${this.baseUrl}/uploadEnergyFile?supplier=${CONFIG.supplier}&tariff=${CONFIG.tariff}&cycle_day=${CONFIG.cycle_day}&profile=${CONFIG.profile}&format=${a}&provider=${b}&resampling=${sample}&divisor=${0!=CONFIG.divisor?CONFIG.divisor:""}&lagHour=${0}&datatype=${d}`;b=new FormData;b.append("file",c);c={method:"POST",body:b};
try{const e=await fetch(a,c);if(!e.ok)throw Error(`HTTP error! status: ${e.status}`);return await e.json()}catch(e){throw console.error("Error uploading file:",e),e;}}async getEstimationProfile(a,b,c,d="none"){try{const e=await fetch(`${this.baseUrl}/getEstimationProfile?supplier=${CONFIG.supplier}&tariff=${CONFIG.tariff}&cycle_day=${CONFIG.cycle_day}&profile=${CONFIG.profile}&start_date=${a}&end_date=${b}&total_energy=${c}&records=${d}`);if(!e.ok)throw Error(`HTTP error: ${e.status}`);return await e.json()}catch(e){throw console.error(`Error fetching estimation profile: ${e}`),
e;}}async getEstimationProfileManual(a,b,c,d,e,h=0,f="none"){try{const k=await fetch(`${this.baseUrl}/getEstimationProfileManual?supplier=${CONFIG.supplier}&tariff=${CONFIG.tariff}&cycle_day=${CONFIG.cycle_day}&profile=${CONFIG.profile}&start_date=${a}&end_date=${b}&total_vazio=${c}&total_cheio=${d}&total_ponta=${e}&lagHour=${h}&records=${f}`);if(!k.ok)throw Error(`HTTP error: ${k.status}`);return await k.json()}catch(k){throw console.error(`Error fetching estimation profile: ${k}`),k;}}async getEOTData(){try{const a=
await fetch(`${this.baseUrl}/getEOTData?key=${CONFIG.EoTKey}`);if(!a.ok)throw Error(`HTTP error: ${a.status}`);return await a.json()}catch(a){throw console.error(`Error fetching EOT data: ${a}`),a;}}}
class PriceTracker{constructor(a,b){this.apiService=a;this.chartUpdatePeriod=b;this.lastUpdateChart=new Date;this.analysisChart=this.lastEstimateDataDisplay=this.lastRealDataDisplay=this.lastEstimateDataFetch=this.lastRealDataFetch=null;this.isRealConsumption=!0;this.zoomOptions={pan:{enabled:!0,mode:"x"},zoom:{wheel:{enabled:!0},pinch:{enabled:!0},drag:{enabled:!1},mode:"x"}};this.chartConfig={type:"bar",data:{labels:[],datasets:[{label:"Energia",data:[],borderColor:"rgba(75, 192, 192, 1)",backgroundColor:"rgba(75, 192, 192, 0.2)",
borderWidth:1,tension:.1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{title:{display:!0,text:"Hora"}},y:{title:{display:!0,text:"Pre\u00e7o"}}},plugins:{tooltip:{callbacks:{title:function(c){return"Hora: "+c[0].label},label:function(c){let d=c.dataset.label||"";d&&="Pre\u00e7o: ";return d+=Number(c.parsed.y).toFixed(2)+" \u20ac/MWh"}}}}}};this.chartConfigNet={type:"bar",data:{labels:[],datasets:[{label:"Energia",data:[],borderColor:"rgba(75, 192, 192, 1)",backgroundColor:"rgba(75, 192, 192, 0.2)",
borderWidth:1,tension:.1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{title:{display:!0,text:"Hora"}},y:{title:{display:!0,text:"Pre\u00e7o"}}},plugins:{tooltip:{callbacks:{title:function(c){return"Hora: "+c[0].label},label:function(c){let d=c.dataset.label||"";d&&="Pre\u00e7o: ";return d+=Number(c.parsed.y).toFixed(4)+" \u20ac/kWh"}}}}}}}initCharts(){var a=document.getElementById("price-chart");a=new Chart(a,this.chartConfig);var b=document.getElementById("price-chart-net");b=new Chart(b,
this.chartConfigNet);var c=document.getElementById("price-chart-analysis");c=new Chart(c,{type:"line"});return[a,b,c]}formatTitleCase(a){return a.toLowerCase().split("-").map(b=>b.charAt(0).toUpperCase()+b.slice(1)).join("-")}setAnalysisPageforSupplier(a,b){var c=new Date,d=new Date(c.getFullYear(),c.getMonth(),c.getDate()-2,0,0);c=new Date(c.getFullYear(),c.getMonth(),c.getDate()-1,23,59);document.getElementById("analysis-comercializador").textContent=this.formatTitleCase(a);document.getElementById("analysis-opcao-horaria").textContent=
this.formatTitleCase(b);(a="luzboa-spot"===a?!0:!1)?(document.getElementById("title_profile").textContent="C\u00e1lculo do Consumo (Per\u00edodo) :",document.getElementById("analysis-periodo-start").value=this.formatDate(d,!0),document.getElementById("analysis-periodo-end").value=this.formatDate(c,!0)):document.getElementById("title_profile").textContent="Curva Perfil "+CONFIG.profile;document.getElementById("blockFileProvider").style.display="";document.getElementById("blockConsumoEstimado").style.display=
"";document.getElementById("blockChart").style.display="";document.getElementById("analysis-periodo-start").disabled=a?!1:!0;document.getElementById("analysis-periodo-end").disabled=a?!1:!0;d=document.getElementById("blockSwitchChart");a?(d.classList.remove("d-flex"),d.style.display="none"):(d.classList.add("d-flex"),d.style.display="flex");document.getElementById("analysis-energia-profile-vazio-total").textContent="0.00 kWh (0.00 \u20ac)";document.getElementById("analysis-energia-profile-cheio-total").textContent=
"0.00 kWh (0.00 \u20ac)";document.getElementById("analysis-energia-profile-ponta-total").textContent="0.00 kWh (0.00 \u20ac)";document.getElementById("analysis-energia-profile-total").textContent="0.00 kWh";document.getElementById("analysis-custo-profile-total").textContent="0.00 \u20ac";document.getElementById("analysis-custo-profile-preco-medio").textContent="0.000000 \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-vazio").textContent="0.000000 \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-cheio").textContent=
"0.000000 \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-ponta").textContent="0.000000 \u20ac/kWh"}fetchServerData(a,b,c=!1){logger("Fetching Price..."+this.lastUpdateChart);this.apiService.getCurrentPrice().then(f=>{logger("Current Price:",f);const k=new Date;var g=0===f["TAR Period"].dst?" / Inverno":" / Ver\u00e3o";g=0===f["TAR Period"].dias?"Dia de Semana"+g:1===f["TAR Period"].dias?"S\u00e1bado"+g:"Domingo"+g;const m=f["TAR Period"].periodo+": "+f["TAR Period"].start+
" - "+f["TAR Period"].end,p=f["Cycle Period"].start.substring(0,10),l=CONFIG.profile;document.getElementById("current-price-omie").textContent=`${f["OMIE price"].toFixed(2)} \u20ac/MWh`;document.getElementById("current-price-net").textContent=`${f["net price"].toFixed(4)} \u20ac/kWh`;document.getElementById("current-profile").textContent=l;document.getElementById("current-cycle_period").textContent=`${p}`;document.getElementById("current-tarifario").textContent=`${f.Tariff} `;document.getElementById("current-supplier").textContent=
`${this.formatTitleCase(f.Supplier)} `;document.getElementById("current-dia").textContent=`${g} `;document.getElementById("current-periodo").textContent=`${m} `;document.getElementById("current-time").textContent=k.toLocaleTimeString("en-US",{hour12:!1})}).catch(f=>{console.error("Error:",f)});""!==CONFIG.EoTKey?this.apiService.getEOTData().then(f=>{logger("EoT Data:",f);const k=f.date,g=f.power,m=f.energy_total,p=f.total_cost,l=f.month_energy_total;f=f.month_total_cost;document.getElementById("current-power").textContent=
`${g} Watts (${k.substring(11,19)})`;document.getElementById("current-consumo-hora").textContent=`${m.toFixed(2)} kWh (${p.toFixed(4)} \u20ac)`;document.getElementById("current-consumo-mensal").textContent=`${l.toFixed(2)} kWh (${f.toFixed(4)} \u20ac)`}).catch(f=>{console.error("Error:",f)}):(document.getElementById("current-power").textContent="N/A",document.getElementById("current-consumo-hora").textContent="N/A",document.getElementById("current-consumo-mensal").textContent="N/A");const d=new Date,
e=Math.floor(this.lastUpdateChart.getMinutes()/15),h=Math.floor(d.getMinutes()/15);if(d.getHours()!==this.lastUpdateChart.getHours()||e!==h||!0===c)this.lastUpdateChart=this.updateChartPeriod(a,b)}formatDate(a,b=!1){const c=a.getFullYear(),d=String(a.getMonth()+1).padStart(2,"0"),e=String(a.getDate()).padStart(2,"0"),h=String(a.getHours()).padStart(2,"0");a=String(a.getMinutes()).padStart(2,"0");return b?`${c}-${d}-${e} ${h}:${a}`:`${c}-${d}-${e}-${h}:${a}`}getColor(a,b,c,d){let e=.25;d&&(e=1);return a<
b+c?`rgba(0, 100, 0, ${e})`:a<b+2*c?`rgba(255, 165, 0, ${e})`:`rgba(255, 0, 0, ${e})`}findIndexByHour(a,b){for(let c=0;c<a.length;c++)if((new Date(a[c].Date.slice(0,16))).getHours()===b)return c;return-1}findIndexByTime(a,b){const c=15*Math.floor(b.getMinutes()/15);b=b.getHours();for(let e=0;e<a.length;e++){var d=new Date(a[e].Date.slice(0,16));const h=d.getHours();d=d.getMinutes();d=15*Math.floor(d/15);if(h===b&&d===c)return e}return-1}updateChartPeriod(a,b){const c=luxon.DateTime;var d=this.chartUpdatePeriod;
const e=new Date,h=new Date;e.setMinutes(0,0,0);const f=new Date(e.getTime()-36E5*d);d=new Date(e.getTime()+36E5*d);logger("Fetching period from:["+f+"] to:["+d+"] date=["+e+"]");this.apiService.getOMIEPricesForPeriod(this.formatDate(f),this.formatDate(d)).then(k=>{logger("OMIE Prices:",k);var g=k.prices;k=k.profile;const m=this.findIndexByTime(g,h),p=Math.min(...g.map(n=>n.Price_PT)),l=Math.max(...g.map(n=>n.Price_PT)),q=Math.min(...g.map(n=>n.Cost)),u=Math.max(...g.map(n=>n.Cost));a.data.labels=
g.map(n=>c.fromISO(n.Date).toUTC().toFormat("HH:mm"));a.data.datasets[0].label="Energia OMIE";a.data.datasets[0].data=g.map(n=>n.Price_PT);let t=(l-p)/3;a.data.datasets[0].backgroundColor=g.map((n,r)=>this.getColor(n.Price_PT,p,t,r==m));a.data.datasets[0].borderColor=g.map((n,r)=>r==m?"darkblue":"lightgray");a.update();this.loadEnergyChart(b,g,k,t,q,u,m)}).catch(k=>{console.error("Error:",k)});return e}getMinMaxDate(a){if(0===a.length)return{minDate:null,maxDate:null};let b=new Date(a[0].Date),c=
new Date(a[0].Date);for(const d of a)a=new Date(d.Date),a<b&&(b=a),a>c&&(c=a);return{minDate:b,maxDate:c}}processEnergyData(a){let b={vazioCost:0,cheioCost:0,pontaCost:0,totalCost:0,vazioEnergy:0,cheioEnergy:0,pontaEnergy:0,vazioAvgPrice:0,cheioAvgPrice:0,pontaAvgPrice:0,totalEnergy:0,globalAvgPrice:0};a.forEach(c=>{null!==c.Vazio&&(b.vazioCost+=c.Cost,b.vazioEnergy+=c.Vazio);null!==c.Cheio&&(b.cheioCost+=c.Cost,b.cheioEnergy+=c.Cheio);null!==c.Ponta&&(b.pontaCost+=c.Cost,b.pontaEnergy+=c.Ponta);
b.totalCost+=c.Cost});b.vazioAvgPrice=b.vazioEnergy?b.vazioCost/b.vazioEnergy:0;b.cheioAvgPrice=b.cheioEnergy?b.cheioCost/b.cheioEnergy:0;b.pontaAvgPrice=b.pontaEnergy?b.pontaCost/b.pontaEnergy:0;b.totalEnergy=b.vazioEnergy+b.cheioEnergy+b.pontaEnergy;b.globalAvgPrice=b.totalCost/b.totalEnergy;return b}getTotalEnergyCost(a){return a.reduce((b,c)=>({sumEnergy:b.sumEnergy+c.Energy,sumCost:b.sumCost+c.Cost,sumVazio:b.sumVazio+c.Vazio,sumCheio:b.sumCheio+c.Cheio,sumPonta:b.sumPonta+c.Ponta}),{sumEnergy:0,
sumCost:0,sumVazio:0,sumCheio:0,sumPonta:0})}updateChartAnalysis(a,b){document.getElementById("title_consumo_real").textContent="Consumo Real :";const c=this.getTotalEnergyCost(b);var d=this.processEnergyData(b);const e=this.getMinMaxDate(b);var h=this.getMinMaxDate(this.lastRealDataFetch);c.sumEnergy.toFixed(2);document.getElementById("analysis-periodo-start").value=this.formatDate(h.minDate,!0);document.getElementById("analysis-periodo-end").value=this.formatDate(h.maxDate,!0);document.getElementById("analysis-custo-total").textContent=
`${d.totalCost.toFixed(2)}`+" \u20ac";document.getElementById("analysis-custo-preco-medio").textContent=`${d.globalAvgPrice.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-energia-vazio-total").textContent=`${d.vazioEnergy.toFixed(2)} `+" kWh ("+`${d.vazioCost.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-cheio-total").textContent=`${d.cheioEnergy.toFixed(2)} `+" kWh ("+`${d.cheioCost.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-ponta-total").textContent=
`${d.pontaEnergy.toFixed(2)} `+" kWh ("+`${d.pontaCost.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-total").textContent=`${d.totalEnergy.toFixed(2)} `+" kWh";document.getElementById("analysis-custo-preco-medio-vazio").textContent=`${d.vazioAvgPrice.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-preco-medio-cheio").textContent=`${d.cheioAvgPrice.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-preco-medio-ponta").textContent=`${d.pontaAvgPrice.toFixed(6)} `+
" \u20ac/kWh";document.getElementById("title_profile").textContent="Curva Perfil "+CONFIG.profile+" ..... Em Processamento ....";d=document.getElementById("analysis-contador-vazio").value;h=document.getElementById("analysis-contador-cheio").value;var f=document.getElementById("analysis-contador-ponta").value;0==d&&(d=c.sumVazio.toFixed(2),document.getElementById("analysis-contador-vazio").value=d);0==h&&(h=c.sumCheio.toFixed(2),document.getElementById("analysis-contador-cheio").value=h);0==f&&(f=
c.sumPonta.toFixed(2),document.getElementById("analysis-contador-ponta").value=f);this.fetchProfileDataBasedOnManual(e,d,h,f);this.lastRealDataDisplay=b;document.getElementById("switch-chart").checked&&(this.isRealConsumption=!0,this.loadDataOnAnalysisChart(a,this.lastRealDataDisplay))}aggregateByHour(a){const b={};a.forEach(c=>{var d=new Date(c.Date);d=(new Date(d.getFullYear(),d.getMonth(),d.getDate(),d.getHours())).toISOString();b[d]||(b[d]={Date:d,Energy:0,Vazio:null,Cheio:null,Ponta:null});null!=
c.Vazio&&(b[d].Vazio+=c.Vazio);null!=c.Cheio&&(b[d].Cheio+=c.Cheio);null!=c.Ponta&&(b[d].Ponta+=c.Ponta);b[d].Energy+=c.Energy;var e=[b[d].Vazio,b[d].Cheio,b[d].Ponta].filter(h=>null!==h);0<e.length&&(c=Math.max(...e),e=Math.min(...e),b[d].Vazio==c?b[d].Cheio==e?(b[d].Vazio+=e,b[d].Cheio=null):b[d].Ponta==e&&(b[d].Vazio+=e,b[d].Ponta=null):b[d].Cheio==c?b[d].Vazio==e?(b[d].Cheio+=e,b[d].Vazio=null):b[d].Ponta==e&&(b[d].Cheio+=e,b[d].Ponta=null):b[d].Ponta==c&&(b[d].Vazio==e?(b[d].Ponta+=e,b[d].Vazio=
null):b[d].Cheio==e&&(b[d].Ponta+=e,b[d].Cheio=null)))});return Object.values(b)}loadEnergyChart(a,b,c,d,e,h,f){const k=luxon.DateTime;d=(h-e)/3;h={type:"bar",label:"Energia "+(CONFIG.supplier.toLowerCase().includes("coopernico")?"Coopernico":"LuzBoa"),data:b.map(l=>l.Cost),backgroundColor:b.map((l,q)=>this.getColor(l.Cost,e,d,q==f)),borderColor:b.map((l,q)=>q==f?"darkblue":"lightgray"),borderWidth:1,yAxisID:"yAxisCost"};var g={type:"line",label:"Vazio",data:c.map(l=>l.Vazio),backgroundColor:"rgba(84, 234, 9, 0.8)",
borderWidth:1,yAxisID:"yAxisConsumo"},m={type:"line",label:"Cheio",data:c.map(l=>l.Cheio),backgroundColor:"rgba(15, 225, 225, 0.9)",borderWidth:1,yAxisID:"yAxisConsumo"};c={type:"line",label:"Ponta",data:c.map(l=>l.Ponta),backgroundColor:"rgba(15, 120, 225, 0.9)",borderWidth:1,yAxisID:"yAxisConsumo"};var p={};p="true"===CONFIG.curva_perfil_c.toLowerCase()?{labels:b.map(l=>k.fromISO(l.Date).toUTC().toFormat("HH:mm")),datasets:[h,g,m,c]}:{labels:b.map(l=>k.fromISO(l.Date).toUTC().toFormat("HH:mm")),
datasets:[h]};a.data=p;a.options={responsive:!0,maintainAspectRatio:!1,scales:{x:{title:{display:!0,text:"Hora"}},yAxisConsumo:{position:"right",display:!1,title:{display:!1,text:"Consumo (kWh)"}},yAxisCost:{position:"left",title:{display:!0,text:"Custo (\u20ac/kWh)"}}},plugins:{tooltip:{callbacks:{title:function(l){return"Hora: "+l[0].label},label:function(l){let q="";return q=0==l.datasetIndex?q+("Custo: "+Number(l.parsed.y).toFixed(4)+" \u20ac"):q+("Quantidade: "+Number(l.parsed.y).toFixed(4)+
" kWh")}}}}};a.update();a.resize()}loadDataOnAnalysisChart(a,b){var c={type:"line",label:"Consumo Vazio",data:b.map(g=>g.Vazio),backgroundColor:"rgba(84, 234, 9, 0.8)",borderWidth:1,yAxisID:"yAxisConsumo"},d={type:"line",label:"Consumo Cheio",data:b.map(g=>g.Cheio),backgroundColor:"rgba(15, 225, 225, 0.9)",borderWidth:1,yAxisID:"yAxisConsumo"},e={type:"line",label:"Consumo Ponta",data:b.map(g=>g.Ponta),backgroundColor:"rgba(15, 120, 225, 0.9)",borderWidth:1,yAxisID:"yAxisConsumo"},h={type:"bar",label:"Custo",
data:b.map(g=>g.Cost),backgroundColor:"rgba(241, 163, 6, 0.5)",borderColor:"rgba(241, 163, 6, 0.5)",borderWidth:1,yAxisID:"yAxisCost"};const f={pan:{enabled:!0,mode:"x"},zoom:{wheel:{enabled:!0},pinch:{enabled:!0},drag:{enabled:!1},mode:"x"}};var k={responsive:!0,maintainAspectRatio:!1,scales:{yAxisConsumo:{position:"left",title:{display:!0,text:"Consumo (kWh)"}},yAxisCost:{position:"right",title:{display:!0,text:"Custo (\u20ac/kWh)"}}},plugins:{zoom:f,title:{display:!0,position:"bottom",text:g=>
"Zoom: "+((f.zoom.wheel.enabled?"enabled":"disabled")+" ("+g.chart.getZoomLevel()+"x), Pan: ")+(f.pan.enabled?"enabled":"disabled")},tooltip:{callbacks:{label:function(g){return 3==g.datasetIndex?"Custo: "+Number(g.parsed.y).toFixed(4)+" \u20ac":"Quantidade: "+Number(g.parsed.y).toFixed(4)+" kWh"}}}}};b={labels:b.map(g=>g.Date),datasets:[c,d,e,h]};a.data=b;a.options=k;a.update();a.resize()}setupSliderForData(a,b){this.getMinMaxDate(b);var c=b.length-1;this.analysisChart=a;this.lastRealDataDisplay=
this.lastRealDataFetch=b;document.getElementById("analysis-slider-periodo").textContent=b[0].Date+"    -    "+b[c].Date;b={id:"slider_chart",enabled:!0,tooltip:"hide",tooltip_split:!1,min:0,max:c,step:1,value:[0,c]};slider.getElement();slider.destroy();slider=new Slider("#analysis-data-range",b);slider.enable();c=this.lastRealDataDisplay.slice(0,c+1);this.updateChartAnalysis(a,c);slider.on("slideStop",this.onSlideStop);slider.on("change",this.onSlideChange)}onSlideChange(a){var b=a.newValue;if(Array.isArray(b)){const c=
priceTrackerApp.lastRealDataFetch;a=b[0];b=b[1];document.getElementById("analysis-slider-periodo").textContent=c[a].Date+"    -    "+c[b].Date}}onSlideStop(a){const b=priceTrackerApp.lastRealDataFetch.slice(a[0],a[1]+1);priceTrackerApp.updateChartAnalysis(priceTrackerApp.analysisChart,b);document.getElementById("title_profile").textContent="Curva Perfil "+CONFIG.profile+" ..... Em Processamento ....";logger("SLIDING",a,b)}getCurrentDataForSlider(){var a=this.lastRealDataFetch,b=priceTrackerApp.getMinMaxDate(a);
return[a,priceTrackerApp.formatDate(b.minDate,!0),priceTrackerApp.formatDate(b.maxDate,!0)]}fetchProfileDataBasedOnManual(a,b,c,d){apiService.getEstimationProfileManual(this.formatDate(a.minDate),this.formatDate(a.maxDate),b,c,d,0,"json").then(e=>{const h=e.Total_Cost/e.Total_energy;document.getElementById("analysis-energia-profile-vazio-total").textContent=`${e.Energy_Vazio.toFixed(2)} `+" kWh ("+`${e.Cost_Vazio.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-cheio-total").textContent=
`${e.Energy_Cheio.toFixed(2)} `+" kWh ("+`${e.Cost_Cheio.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-ponta-total").textContent=`${e.Energy_Ponta.toFixed(2)} `+" kWh ("+`${e.Cost_Ponta.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-total").textContent=`${e.Total_energy.toFixed(2)} `+" kWh";document.getElementById("analysis-custo-profile-total").textContent=`${e.Total_Cost.toFixed(2)} `+" \u20ac";document.getElementById("analysis-custo-profile-preco-medio").textContent=
`${h.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-vazio").textContent=`${e.Vazio_avg_price_cost.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-cheio").textContent=`${e.Cheio_avg_price_cost.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-ponta").textContent=`${e.Ponta_avg_price_cost.toFixed(6)} `+" \u20ac/kWh";""!=e.records&&(this.lastEstimateDataFetch=e.records);document.getElementById("switch-chart").checked||
null===this.lastEstimateDataFetch||priceTrackerApp.loadDataOnAnalysisChart(priceChartAnalysis,priceTrackerApp.lastEstimateDataFetch);"luzboa-spot"==CONFIG.supplier?document.getElementById("title_profile").textContent="C\u00e1lculo do Consumo (Per\u00edodo) :":document.getElementById("title_profile").textContent="Curva Perfil "+CONFIG.profile}).catch(e=>{console.error("fetchProfileDataBasedOnManual Error:",e)})}fetchProfileDataBasedOnFile(a,b){apiService.getEstimationProfile(this.formatDate(a.minDate),
this.formatDate(a.maxDate),b,"json").then(c=>{const d=c.Total_Cost/c.Total_energy;document.getElementById("analysis-energia-profile-vazio-total").textContent=`${c.Energy_Vazio.toFixed(2)} `+" kWh ("+`${c.Cost_Vazio.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-cheio-total").textContent=`${c.Energy_Cheio.toFixed(2)} `+" kWh ("+`${c.Cost_Cheio.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-ponta-total").textContent=`${c.Energy_Ponta.toFixed(2)} `+
" kWh ("+`${c.Cost_Ponta.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-total").textContent=`${c.Total_energy.toFixed(2)} `+" kWh";document.getElementById("analysis-custo-profile-total").textContent=`${c.Total_Cost.toFixed(2)} `+" \u20ac";document.getElementById("analysis-custo-profile-preco-medio").textContent=`${d.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-vazio").textContent=`${c.Vazio_avg_price_cost.toFixed(4)} `+" \u20ac/kWh";
document.getElementById("analysis-custo-profile-preco-medio-cheio").textContent=`${c.Cheio_avg_price_cost.toFixed(4)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-ponta").textContent=`${c.Ponta_avg_price_cost.toFixed(4)} `+" \u20ac/kWh";""!=c.records&&(this.lastEstimateDataDisplay=this.lastEstimateDataFetch=c.records);0==document.getElementById("switch-chart").checked&&(this.isRealConsumption=!1,priceTrackerApp.loadDataOnAnalysisChart(priceChartAnalysis,priceTrackerApp.lastEstimateDataFetch));
document.getElementById("title_profile").textContent="Curva Perfil "+CONFIG.profile}).catch(c=>{console.error("fetchProfileDataBasedOnFile Error:",c)})}}var apiService=null,priceTrackerApp=null,priceChart,priceChartNet,priceChartAnalysis=null,slider=null,timerId,file=null,sample="";
document.addEventListener("DOMContentLoaded",()=>{var a=localStorage.getItem("config");a&&(a=JSON.parse(a),document.getElementById("config-perfil").value=void 0===a.curva_perfil_c?CONFIG.curva_perfil_c:a.curva_perfil_c,document.getElementById("config-hours").value=void 0===a.hours?CONFIG.chart_update_period:a.hours,document.getElementById("config-tariff").value=void 0===a.tariff?CONFIG.tariff:a.tariff,document.getElementById("config-supplier").value=void 0===a.supplier?CONFIG.supplier:a.supplier,
document.getElementById("config-eot-key").value=void 0===a.configEotKey?CONFIG.EoTKey:a.configEotKey,document.getElementById("config-cycle-day").value=void 0===a.cycle_day?CONFIG.cycle_day:a.cycle_day,document.getElementById("config-profile").value=void 0===a.profile?CONFIG.profile:a.profile,document.getElementById("config-refresh-rate").value=void 0===a.chart_update_interval?CONFIG.chart_update_interval:a.chart_update_interval,CONFIG.chart_update_interval=void 0===a.chart_update_interval?CONFIG.chart_update_interval:
a.chart_update_interval,CONFIG.chart_update_period=void 0===a.hours?CONFIG.chart_update_period:a.hours,CONFIG.chart_update_period_net=void 0===a.hours?CONFIG.chart_update_period_net:a.hours,CONFIG.tariff=void 0===a.tariff?CONFIG.tariff:a.tariff,CONFIG.supplier=void 0===a.supplier?CONFIG.supplier:a.supplier,CONFIG.EoTKey=void 0===a.configEotKey?CONFIG.EoTKey:a.configEotKey,CONFIG.curva_perfil_c=void 0===a.curva_perfil_c?CONFIG.curva_perfil_c:a.curva_perfil_c,CONFIG.cycle_day=void 0===a.cycle_day?CONFIG.cycle_day:
a.cycle_day,CONFIG.profile=void 0===a.profile?CONFIG.profile:a.profile,logger("Loaded CONFIG: ",CONFIG));a=window.location.protocol;var b=window.location.hostname;"localhost"===b||"file:"===window.location.protocol?(CONFIG.api_url="http://localhost:15000",CONFIG.allowDebug=!0):(CONFIG.api_url=`${a}//${b}${":15000"}`,CONFIG.allowDebug=!1);logger("Starting the app... ADDRESS:",CONFIG.api_url);apiService=new ApiService(CONFIG.api_url);priceTrackerApp=new PriceTracker(apiService,CONFIG.chart_update_period);
[priceChart,priceChartNet,priceChartAnalysis]=priceTrackerApp.initCharts();document.getElementById("consumo-browse-file").addEventListener("change",handleFileInputChange);document.getElementById("analysis-contador-refresh").addEventListener("click",handleAnaliseRefreshContador);document.getElementById("switch-chart").addEventListener("change",handleSwitchChange_Chart);document.getElementById("configForm").addEventListener("submit",handleStoreConfig);document.getElementById("title_profile").textContent=
"Curva Perfil "+CONFIG.profile;slider=new Slider("#analysis-data-range",{enabled:!1});priceTrackerApp.setAnalysisPageforSupplier(CONFIG.supplier,CONFIG.tariff);priceTrackerApp.fetchServerData(priceChart,priceChartNet,force=!0);resetTimer();document.getElementById("btn-reset-zoom").addEventListener("click",function(){priceChartAnalysis.resetZoom()});document.getElementById("btn-zoom-in").addEventListener("click",function(){priceChartAnalysis.zoom({x:1.1})});document.getElementById("btn-zoom-out").addEventListener("click",
function(){priceChartAnalysis.zoom({x:.9})});document.getElementById("btn-pan-right").addEventListener("click",function(){priceChartAnalysis.pan({x:-100},void 0,"default")});document.getElementById("btn-pan-left").addEventListener("click",function(){priceChartAnalysis.pan({x:100},void 0,"default")});document.getElementById("btn-resample-15m").addEventListener("click",function(){sample="";file&&uploadFile(file)});document.getElementById("btn-resample-1h").addEventListener("click",function(){sample=
"1H";file&&uploadFile(file)});document.getElementById("btn-resample-1d").addEventListener("click",function(){sample="1D";file&&uploadFile(file)});document.getElementById("btn-resample-1w").addEventListener("click",function(){sample="1W";file&&uploadFile(file)});a=["analysis-contador-vazio","analysis-contador-cheio","analysis-contador-ponta"];for(var c of a){const d=document.getElementById(c);d.addEventListener("change",function(){validateInput(d)})}a=new Date;c=new Date(a.getFullYear(),a.getMonth(),
a.getDate()-2,0,0);a=new Date(a.getFullYear(),a.getMonth(),a.getDate()-1,23,59);b=document.getElementById("analysis-periodo-start");flatpickr(b,{enableTime:!0,dateFormat:"Y-m-d H:i",defaultDate:c,time_24hr:!0});c=document.getElementById("analysis-periodo-end");flatpickr(c,{enableTime:!0,dateFormat:"Y-m-d H:i",defaultDate:a,time_24hr:!0})});function logger(...a){var b=!1;const c=localStorage.getItem("config");c&&(b=JSON.parse(c),b=void 0===b.debug?CONFIG.allowDebug:b.debug);b&&console.log(...a)}
function resetTimer(){timerId&&clearInterval(timerId);timerId=setInterval(()=>{priceTrackerApp.fetchServerData(priceChart,priceChartNet)},6E4*CONFIG.chart_update_interval)}
function handleStoreConfig(a){a.preventDefault();a=document.getElementById("config-hours").value;const b=document.getElementById("config-perfil").value,c=document.getElementById("config-tariff").value,d=document.getElementById("config-supplier").value,e=document.getElementById("config-eot-key").value,h=document.getElementById("config-cycle-day").value,f=document.getElementById("config-profile").value,k=document.getElementById("config-refresh-rate").value,g=CONFIG.api_url,m={apiUrl:g,hours:a,tariff:c,
configEotKey:e,supplier:d,curva_perfil_c:b,cycle_day:h,profile:f,chart_update_interval:k};CONFIG.chart_update_period=a;CONFIG.chart_update_period_net=a;CONFIG.tariff=c;CONFIG.supplier=d;CONFIG.EoTKey=e;CONFIG.curva_perfil_c=b;CONFIG.cycle_day=h;CONFIG.profile=f;CONFIG.chart_update_interval=k;priceTrackerApp.apiService=new ApiService(g);priceTrackerApp.chartUpdatePeriod=a;priceTrackerApp.chartUpdatePeriodNet=a;localStorage.setItem("config",JSON.stringify(m));logger("Configuration saved!",CONFIG);resetTimer();
priceTrackerApp.setAnalysisPageforSupplier(CONFIG.supplier,CONFIG.tariff);priceTrackerApp.fetchServerData(priceChart,priceChartNet,force=!0);(new bootstrap.Tab(document.getElementById("home-tab"))).show()}
function handleSwitchChange_Chart(a){a.target.checked?null!=priceTrackerApp.lastRealDataFetch&&(priceTrackerApp.isRealConsumption=!0,priceTrackerApp.loadDataOnAnalysisChart(priceChartAnalysis,priceTrackerApp.lastRealDataDisplay)):null!=priceTrackerApp.lastEstimateDataFetch&&(priceTrackerApp.isRealConsumption=!1,priceTrackerApp.loadDataOnAnalysisChart(priceChartAnalysis,priceTrackerApp.lastEstimateDataFetch))}
function handleAnaliseRefreshContador(a){if("luzboa-spot"==CONFIG.supplier){const h=CONFIG.tariff;a={simples:["analysis-contador-cheio"],bi:["analysis-contador-vazio","analysis-contador-cheio"],tri:["analysis-contador-vazio","analysis-contador-cheio","analysis-contador-ponta"]};var b=Object.keys(a).find(g=>h.toLowerCase().includes(g));const f=a[b]||[];a=document.getElementById("analysisForm");let k=!0;document.querySelectorAll("[data-validate]").forEach(g=>{if(f.includes(g.id)){const m=parseFloat(g.value);
isNaN(m)||0>=m?(g.classList.add("is-invalid"),k=!1):g.classList.remove("is-invalid")}});a.classList.add("was-validated");if(k){a=new Date(document.getElementById("analysis-periodo-start").value);b=new Date(document.getElementById("analysis-periodo-end").value);var c={minDate:a,maxDate:b};a=document.getElementById("analysis-contador-vazio").value.replace(/,/g,".");b=document.getElementById("analysis-contador-cheio").value.replace(/,/g,".");var d=document.getElementById("analysis-contador-ponta").value.replace(/,/g,
".");document.getElementById("title_profile").textContent="C\u00e1lculo do Consumo (Per\u00edodo) : ..... Em Processamento ....";priceTrackerApp.fetchProfileDataBasedOnManual(c,a,b,d)}}else if(null!=priceTrackerApp.lastRealDataFetch){document.getElementById("title_profile").textContent="Curva Perfil "+CONFIG.profile+" ..... Em Processamento ....";c=priceTrackerApp.getMinMaxDate(priceTrackerApp.lastRealDataDisplay);var e=priceTrackerApp.getTotalEnergyCost(priceTrackerApp.lastRealDataDisplay);a=document.getElementById("analysis-contador-vazio").value;
b=document.getElementById("analysis-contador-cheio").value;d=document.getElementById("analysis-contador-ponta").value;0==a&&(a=e.sumVazio.toFixed(2),document.getElementById("analysis-contador-vazio").value=a);0==b&&(b=e.sumCheio.toFixed(2),document.getElementById("analysis-contador-cheio").value=b);0==d&&(d=e.sumPonta.toFixed(2),document.getElementById("analysis-contador-ponta").value=d);priceTrackerApp.fetchProfileDataBasedOnManual(c,a,b,d)}}
async function handleFileInputChange(a){a.target.files&&0!==a.target.files.length&&(file=a.target.files[0])&&uploadFile(file)}
async function uploadFile(a){if(a)try{document.getElementById("title_consumo_real").textContent="Consumo Real : ..... Em Processamento ....";showAlert("Aguarde enquanto os dados s\u00e3o processados...");const b=document.getElementById("consumo-tipo").value.trim(),c=document.getElementById("analisys-provider").innerHTML.trim();logger("File selected:",a.name,"Provider:",c,"ColumnType:",b);const d=await apiService.uploadEnergyFile("json",c,a,b);logger("UploadEnergyFile: File uploaded successfully:",
d);document.getElementById("switch-chart").checked=!0;""!=d.consumo&&(document.getElementById("analysis-contador-vazio").value=d.consumo.Vazio,document.getElementById("analysis-contador-cheio").value=d.consumo.Cheias,document.getElementById("analysis-contador-ponta").value=d.consumo.Ponta);priceTrackerApp.setupSliderForData(priceChartAnalysis,d.records);hideAlert()}catch(b){showAlert("Erro no processamento do ficheiro. Verifique se est\u00e1 a usar o ficheiro correto..."),console.error("Error uploading file:",
b)}}function updateDropDownProviderTitle(a,b){a.preventDefault();document.getElementById("analisys-provider").innerHTML=b.innerHTML}function updateDropDownDivisor(a,b){a.preventDefault();document.getElementById("analisys-divisor").innerHTML=b.innerHTML;CONFIG.divisor="Auto"==b.innerHTML?0:b.innerHTML}function showAlert(a){const b=document.getElementById("processingAlert");b.querySelector("strong").textContent=a;b.style.display="block";new bootstrap.Alert(b)}
function hideAlert(){document.getElementById("processingAlert").style.display="none"}function validateInput(a){const b=parseFloat(a.value);if(isNaN(b)||0>b)return a.classList.add("is-invalid"),!1;a.classList.remove("is-invalid");return!0}function updateDropDownTariffTitle(a,b){a.preventDefault();document.getElementById("current-tarifario").innerHTML=b.innerHTML};
