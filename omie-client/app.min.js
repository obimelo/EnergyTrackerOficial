var CONFIG={api_url:"",tariff:"Tri-Horario-Semanal",year:"2023",curva_perfil_c:"True",supplier:"coopernico-base",chart_update_interval:6E4,chart_update_period:12,chart_update_period_net:12,EoTKey:"XXXXXXXXXX",cycle_day:8,allowDebug:!1};
class ApiService{constructor(b){this.baseUrl=b}async getCurrentPrice(b,a,c,d){try{const e=await fetch(`${this.baseUrl}/getCurrentPrice?tariff=${a}&year=${c}&supplier=${b}&cycle_day=${d}`);if(!e.ok)throw Error(`HTTP error: ${e.status}`);return await e.json()}catch(e){throw console.error(`Error fetching current price: ${e}`),e;}}async getOMIEPricesForPeriod(b,a,c,d,e,f){try{const h=await fetch(`${this.baseUrl}/getOMIEPricesForPeriod?tariff=${a}&supplier=${b}&year=${c}&cycle_day=${d}&start_date=${e}&end_date=${f}`);
if(!h.ok)throw Error(`HTTP error: ${h.status}`);return await h.json()}catch(h){throw console.error(`Error fetching OMIE prices for period: ${h}`),h;}}async uploadEnergyFile(b,a,c,d,e,f,h){b=`${this.baseUrl}/uploadEnergyFile?supplier=${b}&tariff=${a}&year=${c}&cycle_day=${d}&format=${e}&provider=${f}`;a=new FormData;a.append("file",h);h={method:"POST",body:a};try{const k=await fetch(b,h);if(!k.ok)throw Error(`HTTP error! status: ${k.status}`);return await k.json()}catch(k){throw console.error("Error uploading file:",
k),k;}}async getEstimationProfile(b,a,c,d,e,f,h,k="none"){try{const g=await fetch(`${this.baseUrl}/getEstimationProfile?supplier=${b}&tariff=${a}&year=${c}&cycle_day=${d}&start_date=${e}&end_date=${f}&total_energy=${h}&records=${k}`);if(!g.ok)throw Error(`HTTP error: ${g.status}`);return await g.json()}catch(g){throw console.error(`Error fetching estimation profile: ${g}`),g;}}async getEstimationProfileManual(b,a,c,d,e,f,h,k,g,n=0,q="none"){try{const l=await fetch(`${this.baseUrl}/getEstimationProfileManual?supplier=${b}&tariff=${a}&year=${c}&cycle_day=${d}&start_date=${e}&end_date=${f}&total_vazio=${h}&total_cheio=${k}&total_ponta=${g}&lagHour=${n}&records=${q}`);
if(!l.ok)throw Error(`HTTP error: ${l.status}`);return await l.json()}catch(l){throw console.error(`Error fetching estimation profile: ${l}`),l;}}async getEOTData(b,a,c,d,e){try{const f=await fetch(`${this.baseUrl}/getEOTData?supplier=${b}&tariff=${a}&year=${c}&cycle_day=${d}&key=${e}`);if(!f.ok)throw Error(`HTTP error: ${f.status}`);return await f.json()}catch(f){throw console.error(`Error fetching EOT data: ${f}`),f;}}}
class PriceTracker{constructor(b,a){this.apiService=b;this.chartUpdatePeriod=a;this.lastUpdateChart=new Date;this.analysisChart=this.lastEstimateDataDisplay=this.lastRealDataDisplay=this.lastEstimateDataFetch=this.lastRealDataFetch=null;this.isRealConsumption=!0;this.zoomOptions={pan:{enabled:!0,mode:"x"},zoom:{wheel:{enabled:!0},pinch:{enabled:!0},drag:{enabled:!1},mode:"x"}};this.chartConfig={type:"bar",data:{labels:[],datasets:[{label:"Energia",data:[],borderColor:"rgba(75, 192, 192, 1)",backgroundColor:"rgba(75, 192, 192, 0.2)",
borderWidth:1,tension:.1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{title:{display:!0,text:"Hora"}},y:{title:{display:!0,text:"Pre\u00e7o"}}},plugins:{tooltip:{callbacks:{title:function(c){return"Hora: "+c[0].label+":00"},label:function(c){let d=c.dataset.label||"";d&&="Pre\u00e7o: ";return d+=Number(c.parsed.y).toFixed(2)+" \u20ac/MWh"}}}}}};this.chartConfigNet={type:"bar",data:{labels:[],datasets:[{label:"Energia",data:[],borderColor:"rgba(75, 192, 192, 1)",backgroundColor:"rgba(75, 192, 192, 0.2)",
borderWidth:1,tension:.1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{title:{display:!0,text:"Hora"}},y:{title:{display:!0,text:"Pre\u00e7o"}}},plugins:{tooltip:{callbacks:{title:function(c){return"Hora: "+c[0].label+":00"},label:function(c){let d=c.dataset.label||"";d&&="Pre\u00e7o: ";return d+=Number(c.parsed.y).toFixed(4)+" \u20ac/kWh"}}}}}}}initCharts(){var b=document.getElementById("price-chart");b=new Chart(b,this.chartConfig);var a=document.getElementById("price-chart-net");
a=new Chart(a,this.chartConfigNet);var c=document.getElementById("price-chart-analysis");c=new Chart(c,{type:"line"});return[b,a,c]}formatTitleCase(b){return b.toLowerCase().split("-").map(a=>a.charAt(0).toUpperCase()+a.slice(1)).join("-")}setAnalysisPageforSupplier(b,a){var c=new Date;const d=new Date(c.getFullYear(),c.getMonth(),c.getDate()-2,0,0);c=new Date(c.getFullYear(),c.getMonth(),c.getDate()-1,23,59);document.getElementById("analysis-comercializador").textContent=this.formatTitleCase(b);
document.getElementById("analysis-opcao-horaria").textContent=this.formatTitleCase(a);(b="luzboa-spot"===b?!0:!1)?(document.getElementById("title_profile").textContent="C\u00e1lculo do Consumo :",document.getElementById("analysis-periodo-start").value=this.formatDate(d,!0),document.getElementById("analysis-periodo-end").value=this.formatDate(c,!0)):document.getElementById("title_profile").textContent='Curva Perfil "C" :';document.getElementById("blockFileProvider").style.display=b?"none":"";document.getElementById("blockConsumoEstimado").style.display=
b?"none":"";document.getElementById("blockChart").style.display=b?"none":"";document.getElementById("analysis-periodo-start").disabled=b?!1:!0;document.getElementById("analysis-periodo-end").disabled=b?!1:!0;document.getElementById("analysis-energia-profile-vazio-total").textContent="0.00 kWh (0.00 \u20ac)";document.getElementById("analysis-energia-profile-cheio-total").textContent="0.00 kWh (0.00 \u20ac)";document.getElementById("analysis-energia-profile-ponta-total").textContent="0.00 kWh (0.00 \u20ac)";
document.getElementById("analysis-energia-profile-total").textContent="0.00 kWh";document.getElementById("analysis-custo-profile-total").textContent="0.00 \u20ac";document.getElementById("analysis-custo-profile-preco-medio").textContent="0.000000 \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-vazio").textContent="0.000000 \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-cheio").textContent="0.000000 \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-ponta").textContent=
"0.000000 \u20ac/kWh"}fetchServerData(b,a,c=!1){logger("Fetching Price..."+this.lastUpdateChart);this.apiService.getCurrentPrice(CONFIG.supplier,CONFIG.tariff,CONFIG.year,CONFIG.cycle_day).then(d=>{logger("Current Price:",d);const e=new Date;var f=0===d["TAR Period"].dst?" / Inverno":" / Ver\u00e3o";f=0===d["TAR Period"].dias?"Dia de Semana"+f:1===d["TAR Period"].dias?"S\u00e1bado"+f:"Domingo"+f;const h=d["TAR Period"].periodo+": "+d["TAR Period"].start+" - "+d["TAR Period"].end,k=d["Cycle Period"].start.substring(0,
10);document.getElementById("current-price-omie").textContent=`${d["OMIE price"].toFixed(2)} \u20ac/MWh`;document.getElementById("current-price-net").textContent=`${d["net price"].toFixed(4)} \u20ac/kWh`;document.getElementById("current-cycle_period").textContent=`${k}`;document.getElementById("current-tarifario").textContent=`${d.Tariff} `;document.getElementById("current-supplier").textContent=`${this.formatTitleCase(d.Supplier)} `;document.getElementById("current-dia").textContent=`${f} `;document.getElementById("current-periodo").textContent=
`${h} `;document.getElementById("current-time").textContent=e.toLocaleTimeString("en-US",{hour12:!1})}).catch(d=>{console.error("Error:",d)});""===CONFIG.EoTKey||/^X*$/.test(CONFIG.EoTKey)?(document.getElementById("current-power").textContent="N/A",document.getElementById("current-consumo-hora").textContent="N/A"):this.apiService.getEOTData(CONFIG.supplier,CONFIG.tariff,CONFIG.year,CONFIG.cycle_day,CONFIG.EoTKey).then(d=>{logger("EoT Data:",d);const e=d.power,f=d.energy_total;d=d.total_cost;document.getElementById("current-power").textContent=
`${e} Watts `;document.getElementById("current-consumo-hora").textContent=`${f.toFixed(2)} kWh (${d.toFixed(4)} \u20ac)`}).catch(d=>{console.error("Error:",d)});if((new Date).getHours()!==this.lastUpdateChart.getHours()||1==c)this.lastUpdateChart=this.updateChartPeriod(b,a)}formatDate(b,a=!1){const c=b.getFullYear(),d=String(b.getMonth()+1).padStart(2,"0"),e=String(b.getDate()).padStart(2,"0"),f=String(b.getHours()).padStart(2,"0");b=String(b.getMinutes()).padStart(2,"0");return a?`${c}-${d}-${e} ${f}:${b}`:
`${c}-${d}-${e}-${f}:${b}`}getColor(b,a,c,d){let e=.25;d&&(e=1);return b<a+c?`rgba(0, 100, 0, ${e})`:b<a+2*c?`rgba(255, 165, 0, ${e})`:`rgba(255, 0, 0, ${e})`}findIndexByHour(b,a){for(let c=0;c<b.length;c++)if((new Date(b[c].Date.slice(0,16))).getHours()===a)return c;return-1}updateChartPeriod(b,a){const c=luxon.DateTime;var d=this.chartUpdatePeriod;const e=new Date,f=e.getHours();e.setMinutes(0,0,0);const h=new Date(e.getTime()-36E5*d);d=new Date(e.getTime()+36E5*d);logger("Fetching period from:["+
h+"] to:["+d+"] date=["+e+"]");this.apiService.getOMIEPricesForPeriod(CONFIG.supplier,CONFIG.tariff,CONFIG.year,CONFIG.cycle_day,this.formatDate(h),this.formatDate(d)).then(k=>{logger("OMIE Prices:",k);var g=k.prices;k=k.profile;const n=this.findIndexByHour(g,f),q=Math.min(...g.map(m=>m.Price_PT)),l=Math.max(...g.map(m=>m.Price_PT)),p=Math.min(...g.map(m=>m.Cost)),u=Math.max(...g.map(m=>m.Cost));b.data.labels=g.map(m=>c.fromISO(m.Date).toUTC().toFormat("HH"));b.data.datasets[0].label="Energia OMIE";
b.data.datasets[0].data=g.map(m=>m.Price_PT);let t=(l-q)/3;b.data.datasets[0].backgroundColor=g.map((m,r)=>this.getColor(m.Price_PT,q,t,r==n));b.data.datasets[0].borderColor=g.map((m,r)=>r==n?"darkblue":"lightgray");b.update();this.loadEnergyChart(a,g,k,t,p,u,n)}).catch(k=>{console.error("Error:",k)});return e}getMinMaxDate(b){if(0===b.length)return{minDate:null,maxDate:null};let a=new Date(b[0].Date),c=new Date(b[0].Date);for(const d of b)b=new Date(d.Date),b<a&&(a=b),b>c&&(c=b);return{minDate:a,
maxDate:c}}processEnergyData(b){let a={vazioCost:0,cheioCost:0,pontaCost:0,totalCost:0,vazioEnergy:0,cheioEnergy:0,pontaEnergy:0,vazioAvgPrice:0,cheioAvgPrice:0,pontaAvgPrice:0,totalEnergy:0,globalAvgPrice:0};b.forEach(c=>{null!==c.Vazio&&(a.vazioCost+=c.Cost,a.vazioEnergy+=c.Vazio);null!==c.Cheio&&(a.cheioCost+=c.Cost,a.cheioEnergy+=c.Cheio);null!==c.Ponta&&(a.pontaCost+=c.Cost,a.pontaEnergy+=c.Ponta);a.totalCost+=c.Cost});a.vazioAvgPrice=a.vazioEnergy?a.vazioCost/a.vazioEnergy:0;a.cheioAvgPrice=
a.cheioEnergy?a.cheioCost/a.cheioEnergy:0;a.pontaAvgPrice=a.pontaEnergy?a.pontaCost/a.pontaEnergy:0;a.totalEnergy=a.vazioEnergy+a.cheioEnergy+a.pontaEnergy;a.globalAvgPrice=a.totalCost/a.totalEnergy;return a}getTotalEnergyCost(b){return b.reduce((a,c)=>({sumEnergy:a.sumEnergy+c.Energy,sumCost:a.sumCost+c.Cost,sumVazio:a.sumVazio+c.Vazio,sumCheio:a.sumCheio+c.Cheio,sumPonta:a.sumPonta+c.Ponta}),{sumEnergy:0,sumCost:0,sumVazio:0,sumCheio:0,sumPonta:0})}updateChartAnalysis(b,a){document.getElementById("title_consumo_real").textContent=
"Consumo Real :";const c=this.getTotalEnergyCost(a);var d=this.processEnergyData(a);const e=this.getMinMaxDate(a);var f=this.getMinMaxDate(this.lastRealDataFetch);c.sumEnergy.toFixed(2);document.getElementById("analysis-periodo-start").value=this.formatDate(f.minDate,!0);document.getElementById("analysis-periodo-end").value=this.formatDate(f.maxDate,!0);document.getElementById("analysis-custo-total").textContent=`${d.totalCost.toFixed(2)}`+" \u20ac";document.getElementById("analysis-custo-preco-medio").textContent=
`${d.globalAvgPrice.toFixed(4)} `+" \u20ac/kWh";document.getElementById("analysis-energia-vazio-total").textContent=`${d.vazioEnergy.toFixed(2)} `+" kWh ("+`${d.vazioCost.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-cheio-total").textContent=`${d.cheioEnergy.toFixed(2)} `+" kWh ("+`${d.cheioCost.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-ponta-total").textContent=`${d.pontaEnergy.toFixed(2)} `+" kWh ("+`${d.pontaCost.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-total").textContent=
`${d.totalEnergy.toFixed(2)} `+" kWh";document.getElementById("analysis-custo-preco-medio-vazio").textContent=`${d.vazioAvgPrice.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-preco-medio-cheio").textContent=`${d.cheioAvgPrice.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-preco-medio-ponta").textContent=`${d.pontaAvgPrice.toFixed(6)} `+" \u20ac/kWh";document.getElementById("title_profile").textContent='Curva Perfil "C" ..... Em Processamento ....';d=document.getElementById("analysis-contador-vazio").value;
f=document.getElementById("analysis-contador-cheio").value;var h=document.getElementById("analysis-contador-ponta").value;0==d&&(d=c.sumVazio.toFixed(2),document.getElementById("analysis-contador-vazio").value=d);0==f&&(f=c.sumCheio.toFixed(2),document.getElementById("analysis-contador-cheio").value=f);0==h&&(h=c.sumPonta.toFixed(2),document.getElementById("analysis-contador-ponta").value=h);this.fetchProfileDataBasedOnManual(e,d,f,h);this.lastRealDataDisplay=a;document.getElementById("switch-chart").checked&&
(this.isRealConsumption=!0,this.loadDataOnAnalysisChart(b,this.lastRealDataDisplay))}aggregateByHour(b){const a={};b.forEach(c=>{var d=new Date(c.Date);d=(new Date(d.getFullYear(),d.getMonth(),d.getDate(),d.getHours())).toISOString();a[d]||(a[d]={Date:d,Energy:0,Vazio:null,Cheio:null,Ponta:null});null!=c.Vazio&&(a[d].Vazio+=c.Vazio);null!=c.Cheio&&(a[d].Cheio+=c.Cheio);null!=c.Ponta&&(a[d].Ponta+=c.Ponta);a[d].Energy+=c.Energy;var e=[a[d].Vazio,a[d].Cheio,a[d].Ponta].filter(f=>null!==f);0<e.length&&
(c=Math.max(...e),e=Math.min(...e),a[d].Vazio==c?a[d].Cheio==e?(a[d].Vazio+=e,a[d].Cheio=null):a[d].Ponta==e&&(a[d].Vazio+=e,a[d].Ponta=null):a[d].Cheio==c?a[d].Vazio==e?(a[d].Cheio+=e,a[d].Vazio=null):a[d].Ponta==e&&(a[d].Cheio+=e,a[d].Ponta=null):a[d].Ponta==c&&(a[d].Vazio==e?(a[d].Ponta+=e,a[d].Vazio=null):a[d].Cheio==e&&(a[d].Ponta+=e,a[d].Cheio=null)))});return Object.values(a)}loadEnergyChart(b,a,c,d,e,f,h){const k=luxon.DateTime;d=(f-e)/3;var g=this.aggregateByHour(c);c={type:"bar",label:"Energia Coopernico",
data:a.map(l=>l.Cost),backgroundColor:a.map((l,p)=>this.getColor(l.Cost,e,d,p==h)),borderColor:a.map((l,p)=>p==h?"darkblue":"lightgray"),borderWidth:1,yAxisID:"yAxisCost"};f={type:"line",label:"Vazio",data:g.map(l=>l.Vazio),backgroundColor:"rgba(84, 234, 9, 0.8)",borderWidth:1,yAxisID:"yAxisConsumo"};var n={type:"line",label:"Cheio",data:g.map(l=>l.Cheio),backgroundColor:"rgba(15, 225, 225, 0.9)",borderWidth:1,yAxisID:"yAxisConsumo"};g={type:"line",label:"Ponta",data:g.map(l=>l.Ponta),backgroundColor:"rgba(15, 120, 225, 0.9)",
borderWidth:1,yAxisID:"yAxisConsumo"};var q={};q="true"===CONFIG.curva_perfil_c.toLowerCase()?{labels:a.map(l=>k.fromISO(l.Date).toUTC().toFormat("HH")),datasets:[c,f,n,g]}:{labels:a.map(l=>k.fromISO(l.Date).toUTC().toFormat("HH")),datasets:[c]};b.data=q;b.options={responsive:!0,maintainAspectRatio:!1,scales:{x:{title:{display:!0,text:"Hora"}},yAxisConsumo:{position:"right",display:!1,title:{display:!1,text:"Consumo (kWh)"}},yAxisCost:{position:"left",title:{display:!0,text:"Custo (\u20ac/kWh)"}}},
plugins:{tooltip:{callbacks:{title:function(l){return"Hora: "+l[0].label+":00"},label:function(l){let p="";return p=0==l.datasetIndex?p+("Custo: "+Number(l.parsed.y).toFixed(4)+" \u20ac"):p+("Quantidade: "+Number(l.parsed.y).toFixed(4)+" kWh")}}}}};b.update();b.resize()}loadDataOnAnalysisChart(b,a){var c={type:"line",label:"Consumo Vazio",data:a.map(g=>g.Vazio),backgroundColor:"rgba(84, 234, 9, 0.8)",borderWidth:1,yAxisID:"yAxisConsumo"},d={type:"line",label:"Consumo Cheio",data:a.map(g=>g.Cheio),
backgroundColor:"rgba(15, 225, 225, 0.9)",borderWidth:1,yAxisID:"yAxisConsumo"},e={type:"line",label:"Consumo Ponta",data:a.map(g=>g.Ponta),backgroundColor:"rgba(15, 120, 225, 0.9)",borderWidth:1,yAxisID:"yAxisConsumo"},f={type:"bar",label:"Custo",data:a.map(g=>g.Cost),backgroundColor:"rgba(241, 163, 6, 0.5)",borderColor:"rgba(241, 163, 6, 0.5)",borderWidth:1,yAxisID:"yAxisCost"};const h={pan:{enabled:!0,mode:"x"},zoom:{wheel:{enabled:!0},pinch:{enabled:!0},drag:{enabled:!1},mode:"x"}};var k={responsive:!0,
maintainAspectRatio:!1,scales:{yAxisConsumo:{position:"left",title:{display:!0,text:"Consumo (kWh)"}},yAxisCost:{position:"right",title:{display:!0,text:"Custo (\u20ac/kWh)"}}},plugins:{zoom:h,title:{display:!0,position:"bottom",text:g=>"Zoom: "+((h.zoom.wheel.enabled?"enabled":"disabled")+" ("+g.chart.getZoomLevel()+"x), Pan: ")+(h.pan.enabled?"enabled":"disabled")},tooltip:{callbacks:{label:function(g){return 3==g.datasetIndex?"Custo: "+Number(g.parsed.y).toFixed(4)+" \u20ac":"Quantidade: "+Number(g.parsed.y).toFixed(4)+
" kWh"}}}}};a={labels:a.map(g=>g.Date),datasets:[c,d,e,f]};b.data=a;b.options=k;b.update();b.resize()}setupSliderForData(b,a){this.getMinMaxDate(a);var c=a.length-1;this.analysisChart=b;this.lastRealDataDisplay=this.lastRealDataFetch=a;document.getElementById("analysis-slider-periodo").textContent=a[0].Date+"    -    "+a[c].Date;a={id:"slider_chart",enabled:!0,tooltip:"hide",tooltip_split:!1,min:0,max:c,step:1,value:[0,c]};slider.getElement();slider.destroy();slider=new Slider("#analysis-data-range",
a);slider.enable();c=this.lastRealDataDisplay.slice(0,c+1);this.updateChartAnalysis(b,c);slider.on("slideStop",this.onSlideStop);slider.on("change",this.onSlideChange)}onSlideChange(b){var a=b.newValue;if(Array.isArray(a)){const c=priceTrackerApp.lastRealDataFetch;b=a[0];a=a[1];document.getElementById("analysis-slider-periodo").textContent=c[b].Date+"    -    "+c[a].Date}}onSlideStop(b){const a=priceTrackerApp.lastRealDataFetch.slice(b[0],b[1]+1);priceTrackerApp.updateChartAnalysis(priceTrackerApp.analysisChart,
a);document.getElementById("title_profile").textContent='Curva Perfil "C" ..... Em Processamento ....';logger("SLIDING",b,a)}getCurrentDataForSlider(){var b=this.lastRealDataFetch,a=priceTrackerApp.getMinMaxDate(b);return[b,priceTrackerApp.formatDate(a.minDate,!0),priceTrackerApp.formatDate(a.maxDate,!0)]}fetchProfileDataBasedOnManual(b,a,c,d){apiService.getEstimationProfileManual(CONFIG.supplier,CONFIG.tariff,CONFIG.year,CONFIG.cycle_day,this.formatDate(b.minDate),this.formatDate(b.maxDate),a,c,
d,1,"json").then(e=>{const f=e.Total_Cost/e.Total_energy;document.getElementById("analysis-energia-profile-vazio-total").textContent=`${e.Energy_Vazio.toFixed(2)} `+" kWh ("+`${e.Cost_Vazio.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-cheio-total").textContent=`${e.Energy_Cheio.toFixed(2)} `+" kWh ("+`${e.Cost_Cheio.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-ponta-total").textContent=`${e.Energy_Ponta.toFixed(2)} `+" kWh ("+`${e.Cost_Ponta.toFixed(2)} `+
" \u20ac)";document.getElementById("analysis-energia-profile-total").textContent=`${e.Total_energy.toFixed(2)} `+" kWh";document.getElementById("analysis-custo-profile-total").textContent=`${e.Total_Cost.toFixed(2)} `+" \u20ac";document.getElementById("analysis-custo-profile-preco-medio").textContent=`${f.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-vazio").textContent=`${e.Vazio_avg_price_cost.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-cheio").textContent=
`${e.Cheio_avg_price_cost.toFixed(6)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-ponta").textContent=`${e.Ponta_avg_price_cost.toFixed(6)} `+" \u20ac/kWh";""!=e.records&&(this.lastEstimateDataFetch=e.records);document.getElementById("switch-chart").checked||null===this.lastEstimateDataFetch||priceTrackerApp.loadDataOnAnalysisChart(priceChartAnalysis,priceTrackerApp.lastEstimateDataFetch);"luzboa-spot"==CONFIG.supplier?document.getElementById("title_profile").textContent=
"C\u00e1lculo do Consumo :":document.getElementById("title_profile").textContent='Curva Perfil "C" :'}).catch(e=>{console.error("fetchProfileDataBasedOnManual Error:",e)})}fetchProfileDataBasedOnFile(b,a){apiService.getEstimationProfile(CONFIG.supplier,CONFIG.tariff,CONFIG.year,CONFIG.cycle_day,this.formatDate(b.minDate),this.formatDate(b.maxDate),a,"json").then(c=>{const d=c.Total_Cost/c.Total_energy;document.getElementById("analysis-energia-profile-vazio-total").textContent=`${c.Energy_Vazio.toFixed(2)} `+
" kWh ("+`${c.Cost_Vazio.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-cheio-total").textContent=`${c.Energy_Cheio.toFixed(2)} `+" kWh ("+`${c.Cost_Cheio.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-ponta-total").textContent=`${c.Energy_Ponta.toFixed(2)} `+" kWh ("+`${c.Cost_Ponta.toFixed(2)} `+" \u20ac)";document.getElementById("analysis-energia-profile-total").textContent=`${c.Total_energy.toFixed(2)} `+" kWh";document.getElementById("analysis-custo-profile-total").textContent=
`${c.Total_Cost.toFixed(2)} `+" \u20ac";document.getElementById("analysis-custo-profile-preco-medio").textContent=`${d.toFixed(4)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-vazio").textContent=`${c.Vazio_avg_price_cost.toFixed(4)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-cheio").textContent=`${c.Cheio_avg_price_cost.toFixed(4)} `+" \u20ac/kWh";document.getElementById("analysis-custo-profile-preco-medio-ponta").textContent=`${c.Ponta_avg_price_cost.toFixed(4)} `+
" \u20ac/kWh";""!=c.records&&(this.lastEstimateDataDisplay=this.lastEstimateDataFetch=c.records);0==document.getElementById("switch-chart").checked&&(this.isRealConsumption=!1,priceTrackerApp.loadDataOnAnalysisChart(priceChartAnalysis,priceTrackerApp.lastEstimateDataFetch));document.getElementById("title_profile").textContent='Curva Perfil "C" :'}).catch(c=>{console.error("fetchProfileDataBasedOnFile Error:",c)})}}
var apiService=null,priceTrackerApp=null,priceChart,priceChartNet,priceChartAnalysis=null,slider=null;
document.addEventListener("DOMContentLoaded",()=>{var b=localStorage.getItem("config");b&&(b=JSON.parse(b),document.getElementById("config-perfil").value=void 0===b.curva_perfil_c?CONFIG.curva_perfil_c:b.curva_perfil_c,document.getElementById("config-hours").value=void 0===b.hours?CONFIG.chart_update_period:b.hours,document.getElementById("config-tariff").value=void 0===b.tariff?CONFIG.tariff:b.tariff,document.getElementById("config-supplier").value=void 0===b.supplier?CONFIG.supplier:b.supplier,
document.getElementById("config-year").value=void 0===b.year?CONFIG.year:b.year,document.getElementById("config-eot-key").value=void 0===b.configEotKey?CONFIG.EoTKey:b.configEotKey,document.getElementById("config-cycle-day").value=void 0===b.cycle_day?CONFIG.cycle_day:b.cycle_day,CONFIG.chart_update_period=void 0===b.hours?CONFIG.chart_update_period:b.hours,CONFIG.chart_update_period_net=void 0===b.hours?CONFIG.chart_update_period_net:b.hours,CONFIG.tariff=void 0===b.tariff?CONFIG.tariff:b.tariff,
CONFIG.supplier=void 0===b.supplier?CONFIG.supplier:b.supplier,CONFIG.year=void 0===b.year?CONFIG.year:b.year,CONFIG.EoTKey=void 0===b.configEotKey?CONFIG.EoTKey:b.configEotKey,CONFIG.curva_perfil_c=void 0===b.curva_perfil_c?CONFIG.curva_perfil_c:b.curva_perfil_c,CONFIG.cycle_day=void 0===b.cycle_day?CONFIG.cycle_day:b.cycle_day,logger("Loaded CONFIG: ",CONFIG));b=window.location.protocol;var a=window.location.hostname;"localhost"===a||"file:"===window.location.protocol?(CONFIG.api_url="http://localhost:5000",
CONFIG.allowDebug=!0):(CONFIG.api_url=`${b}//${a}${":5000"}`,CONFIG.allowDebug=!1);logger("Starting the app... ADDRESS:",CONFIG.api_url);apiService=new ApiService(CONFIG.api_url);priceTrackerApp=new PriceTracker(apiService,CONFIG.chart_update_period);[priceChart,priceChartNet,priceChartAnalysis]=priceTrackerApp.initCharts();document.getElementById("consumo-browse-file").addEventListener("change",handleFileInputChange);document.getElementById("analysis-contador-refresh").addEventListener("click",handleAnaliseRefreshContador);
document.getElementById("switch-chart").addEventListener("change",handleSwitchChange_Chart);document.getElementById("configForm").addEventListener("submit",handleStoreConfig);slider=new Slider("#analysis-data-range",{enabled:!1});priceTrackerApp.setAnalysisPageforSupplier(CONFIG.supplier,CONFIG.tariff);priceTrackerApp.fetchServerData(priceChart,priceChartNet,force=!0);setInterval(()=>{priceTrackerApp.fetchServerData(priceChart,priceChartNet)},6E4);document.getElementById("btn-reset-zoom").addEventListener("click",
function(){priceChartAnalysis.resetZoom()});document.getElementById("btn-zoom-in").addEventListener("click",function(){priceChartAnalysis.zoom({x:1.1})});document.getElementById("btn-zoom-out").addEventListener("click",function(){priceChartAnalysis.zoom({x:.9})});document.getElementById("btn-pan-right").addEventListener("click",function(){priceChartAnalysis.pan({x:-100},void 0,"default")});document.getElementById("btn-pan-left").addEventListener("click",function(){priceChartAnalysis.pan({x:100},void 0,
"default")});b=["analysis-contador-vazio","analysis-contador-cheio","analysis-contador-ponta"];for(var c of b){const d=document.getElementById(c);d.addEventListener("change",function(){validateInput(d)})}b=new Date;c=new Date(b.getFullYear(),b.getMonth(),b.getDate()-2,0,0);b=new Date(b.getFullYear(),b.getMonth(),b.getDate()-1,23,59);a=document.getElementById("analysis-periodo-start");flatpickr(a,{enableTime:!0,dateFormat:"Y-m-d H:i",defaultDate:c,time_24hr:!0});c=document.getElementById("analysis-periodo-end");
flatpickr(c,{enableTime:!0,dateFormat:"Y-m-d H:i",defaultDate:b,time_24hr:!0})});function logger(...b){var a=!1;const c=localStorage.getItem("config");c&&(a=JSON.parse(c),a=void 0===a.debug?CONFIG.allowDebug:a.debug);a&&console.log(...b)}
function handleStoreConfig(b){b.preventDefault();b=document.getElementById("config-hours").value;const a=document.getElementById("config-perfil").value,c=document.getElementById("config-tariff").value,d=document.getElementById("config-supplier").value,e=document.getElementById("config-year").value,f=document.getElementById("config-eot-key").value,h=document.getElementById("config-cycle-day").value,k=CONFIG.api_url,g={apiUrl:k,hours:b,tariff:c,year:e,configEotKey:f,supplier:d,curva_perfil_c:a,cycle_day:h};
CONFIG.chart_update_period=b;CONFIG.chart_update_period_net=b;CONFIG.tariff=c;CONFIG.supplier=d;CONFIG.year=e;CONFIG.EoTKey=f;CONFIG.curva_perfil_c=a;CONFIG.cycle_day=h;priceTrackerApp.apiService=new ApiService(k);priceTrackerApp.chartUpdatePeriod=b;priceTrackerApp.chartUpdatePeriodNet=b;localStorage.setItem("config",JSON.stringify(g));logger("Configuration saved!",CONFIG);priceTrackerApp.setAnalysisPageforSupplier(CONFIG.supplier,CONFIG.tariff);priceTrackerApp.fetchServerData(priceChart,priceChartNet,
force=!0);(new bootstrap.Tab(document.getElementById("home-tab"))).show()}function handleSwitchChange_Chart(b){b.target.checked?null!=priceTrackerApp.lastRealDataFetch&&(priceTrackerApp.isRealConsumption=!0,priceTrackerApp.loadDataOnAnalysisChart(priceChartAnalysis,priceTrackerApp.lastRealDataDisplay)):null!=priceTrackerApp.lastEstimateDataFetch&&(priceTrackerApp.isRealConsumption=!1,priceTrackerApp.loadDataOnAnalysisChart(priceChartAnalysis,priceTrackerApp.lastEstimateDataFetch))}
function handleAnaliseRefreshContador(b){if("luzboa-spot"==CONFIG.supplier){const f=CONFIG.tariff;b={simples:["analysis-contador-cheio"],bi:["analysis-contador-vazio","analysis-contador-cheio"],tri:["analysis-contador-vazio","analysis-contador-cheio","analysis-contador-ponta"]};var a=Object.keys(b).find(g=>f.toLowerCase().includes(g));const h=b[a]||[];b=document.getElementById("analysisForm");let k=!0;document.querySelectorAll("[data-validate]").forEach(g=>{if(h.includes(g.id)){const n=parseFloat(g.value);
isNaN(n)||0>=n?(g.classList.add("is-invalid"),k=!1):g.classList.remove("is-invalid")}});b.classList.add("was-validated");if(k){b=new Date(document.getElementById("analysis-periodo-start").value);a=new Date(document.getElementById("analysis-periodo-end").value);var c={minDate:b,maxDate:a};b=document.getElementById("analysis-contador-vazio").value;a=document.getElementById("analysis-contador-cheio").value;var d=document.getElementById("analysis-contador-ponta").value;document.getElementById("title_profile").textContent=
"C\u00e1lculo do Consumo : ..... Em Processamento ....";priceTrackerApp.fetchProfileDataBasedOnManual(c,b,a,d)}}else if(null!=priceTrackerApp.lastRealDataFetch){document.getElementById("title_profile").textContent='Curva Perfil "C" ..... Em Processamento ....';c=priceTrackerApp.getMinMaxDate(priceTrackerApp.lastRealDataDisplay);var e=priceTrackerApp.getTotalEnergyCost(priceTrackerApp.lastRealDataDisplay);b=document.getElementById("analysis-contador-vazio").value;a=document.getElementById("analysis-contador-cheio").value;
d=document.getElementById("analysis-contador-ponta").value;0==b&&(b=e.sumVazio.toFixed(2),document.getElementById("analysis-contador-vazio").value=b);0==a&&(a=e.sumCheio.toFixed(2),document.getElementById("analysis-contador-cheio").value=a);0==d&&(d=e.sumPonta.toFixed(2),document.getElementById("analysis-contador-ponta").value=d);priceTrackerApp.fetchProfileDataBasedOnManual(c,b,a,d)}}
async function handleFileInputChange(b){if(b.target.files&&0!==b.target.files.length&&(b=b.target.files[0]))try{document.getElementById("title_consumo_real").textContent="Consumo Real : ..... Em Processamento ....";showAlert("Aguarde enquanto os dados s\u00e3o processados...");const a=document.getElementById("analisys-provider").innerHTML.trim();logger("File selected:",b.name,"Provider:",a);const c=await apiService.uploadEnergyFile(CONFIG.supplier,CONFIG.tariff,CONFIG.year,CONFIG.cycle_day,"json",
a,b);logger("UploadEnergyFile: File uploaded successfully:",c);document.getElementById("switch-chart").checked=!0;priceTrackerApp.setupSliderForData(priceChartAnalysis,c);hideAlert()}catch(a){showAlert("Erro no processamento do ficheiro. Verifique se est\u00e1 a usar o ficheiro correto..."),console.error("Error uploading file:",a)}}function updateDropDownProviderTitle(b,a){b.preventDefault();document.getElementById("analisys-provider").innerHTML=a.innerHTML}
function showAlert(b){const a=document.getElementById("processingAlert");a.querySelector("strong").textContent=b;a.style.display="block";new bootstrap.Alert(a)}function hideAlert(){document.getElementById("processingAlert").style.display="none"}function validateInput(b){const a=parseFloat(b.value);if(isNaN(a)||0>a)return b.classList.add("is-invalid"),!1;b.classList.remove("is-invalid");return!0};
